/*
 * Transfer webhooks
 *
 * Adyen sends webhooks to inform your system about incoming and outgoing transfers in your platform.  You can use these webhooks to build your implementation. For example, you can use this information to update balances in your own dashboards or to keep track of incoming funds.
 *
 * The version of the OpenAPI document: 4
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

#nullable enable

using System;
using System.IO;
using System.Linq;
using System.Collections;
using System.Collections.Generic;
using System.Text;
using System.Text.Json;
using System.Text.RegularExpressions;
using Adyen;
using Adyen.Core.Options;
using Adyen.TransferWebhooks.Models;
#if NETSTANDARD2_0 || NET462
using Adyen.Core;
#endif
using Models = Adyen.TransferWebhooks.Models;
using System.Runtime.CompilerServices;

namespace Adyen.TransferWebhooks.Client
{
    /// <summary>
    /// Utility functions providing some benefit to API client consumers.
    /// </summary>
    public static partial class ClientUtils
    {
        /// <summary>
        /// A delegate for events.
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        /// <returns></returns>
        public delegate void EventHandler<T>(object sender, T e) where T : EventArgs;
    
        /// <summary>
        /// Returns true when deserialization succeeds.
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="json"></param>
        /// <param name="options"></param>
        /// <param name="result"></param>
        /// <returns></returns>
        public static bool TryDeserialize<T>(string json, JsonSerializerOptions options, [global::System.Diagnostics.CodeAnalysis.NotNullWhen(true)] out T? result)
        {
            try
            {
                result = JsonSerializer.Deserialize<T>(json, options);
                return result != null;
            }
            catch (Exception)
            {
                result = default;
                return false;
            }
        }

        /// <summary>
        /// Returns true when deserialization succeeds.
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="reader"></param>
        /// <param name="options"></param>
        /// <param name="result"></param>
        /// <returns></returns>
        public static bool TryDeserialize<T>(ref Utf8JsonReader reader, JsonSerializerOptions options, [global::System.Diagnostics.CodeAnalysis.NotNullWhen(true)] out T? result)
        {
            try
            {
                result = JsonSerializer.Deserialize<T>(ref reader, options);
                return result != null;
            }
            catch (Exception)
            {
                result = default;
                return false;
            }
        }

        /// <summary>
        /// The format to use for DateTime serialization.
        /// </summary>
        public const string ISO8601_DATETIME_FORMAT = "o";
        
        /// <summary>
        /// If parameter is DateTime, output in a formatted string (default ISO 8601), customizable with Configuration.DateTime.
        /// If parameter is a list, join the list with ",".
        /// Otherwise just return the string.
        /// </summary>
        /// <param name="obj">The parameter (header, path, query, form).</param>
        /// <param name="format">The DateTime serialization format.</param>
        /// <returns>Formatted string.</returns>
        public static string? ParameterToString(object? obj, string? format = ISO8601_DATETIME_FORMAT)
        {
            if (obj is DateTime dateTime)
                // Return a formatted date string - Can be customized with Configuration.DateTimeFormat
                // Defaults to an ISO 8601, using the known as a Round-trip date/time pattern ("o")
                // https://msdn.microsoft.com/en-us/library/az4se3k1(v=vs.110).aspx#Anchor_8
                // For example: 2009-06-15T13:45:30.0000000
                return dateTime.ToString(format);
            if (obj is DateTimeOffset dateTimeOffset)
                // Return a formatted date string - Can be customized with Configuration.DateTimeFormat
                // Defaults to an ISO 8601, using the known as a Round-trip date/time pattern ("o")
                // https://msdn.microsoft.com/en-us/library/az4se3k1(v=vs.110).aspx#Anchor_8
                // For example: 2009-06-15T13:45:30.0000000
                return dateTimeOffset.ToString(format);
            if (obj is DateOnly dateOnly)
                return dateOnly.ToString(format);
            if (obj is bool boolean)
                return boolean ? "true" : "false";
            if (obj is Models.AULocalAccountIdentification.TypeEnum aULocalAccountIdentificationTypeEnum)
                return Models.AULocalAccountIdentification.TypeEnum.ToJsonValue(aULocalAccountIdentificationTypeEnum);
            if (obj is Models.AdditionalBankIdentification.TypeEnum additionalBankIdentificationTypeEnum)
                return Models.AdditionalBankIdentification.TypeEnum.ToJsonValue(additionalBankIdentificationTypeEnum);
            if (obj is Models.AmountAdjustment.AmountAdjustmentTypeEnum amountAdjustmentAmountAdjustmentTypeEnum)
                return Models.AmountAdjustment.AmountAdjustmentTypeEnum.ToJsonValue(amountAdjustmentAmountAdjustmentTypeEnum);
            if (obj is Models.BRLocalAccountIdentification.TypeEnum bRLocalAccountIdentificationTypeEnum)
                return Models.BRLocalAccountIdentification.TypeEnum.ToJsonValue(bRLocalAccountIdentificationTypeEnum);
            if (obj is Models.BankCategoryData.PriorityEnum bankCategoryDataPriorityEnum)
                return Models.BankCategoryData.PriorityEnum.ToJsonValue(bankCategoryDataPriorityEnum);
            if (obj is Models.BankCategoryData.TypeEnum bankCategoryDataTypeEnum)
                return Models.BankCategoryData.TypeEnum.ToJsonValue(bankCategoryDataTypeEnum);
            if (obj is Models.CALocalAccountIdentification.AccountTypeEnum cALocalAccountIdentificationAccountTypeEnum)
                return Models.CALocalAccountIdentification.AccountTypeEnum.ToJsonValue(cALocalAccountIdentificationAccountTypeEnum);
            if (obj is Models.CALocalAccountIdentification.TypeEnum cALocalAccountIdentificationTypeEnum)
                return Models.CALocalAccountIdentification.TypeEnum.ToJsonValue(cALocalAccountIdentificationTypeEnum);
            if (obj is Models.CZLocalAccountIdentification.TypeEnum cZLocalAccountIdentificationTypeEnum)
                return Models.CZLocalAccountIdentification.TypeEnum.ToJsonValue(cZLocalAccountIdentificationTypeEnum);
            if (obj is Models.ConfirmationTrackingData.StatusEnum confirmationTrackingDataStatusEnum)
                return Models.ConfirmationTrackingData.StatusEnum.ToJsonValue(confirmationTrackingDataStatusEnum);
            if (obj is Models.ConfirmationTrackingData.TypeEnum confirmationTrackingDataTypeEnum)
                return Models.ConfirmationTrackingData.TypeEnum.ToJsonValue(confirmationTrackingDataTypeEnum);
            if (obj is Models.DKLocalAccountIdentification.TypeEnum dKLocalAccountIdentificationTypeEnum)
                return Models.DKLocalAccountIdentification.TypeEnum.ToJsonValue(dKLocalAccountIdentificationTypeEnum);
            if (obj is Models.EstimationTrackingData.TypeEnum estimationTrackingDataTypeEnum)
                return Models.EstimationTrackingData.TypeEnum.ToJsonValue(estimationTrackingDataTypeEnum);
            if (obj is Models.HKLocalAccountIdentification.TypeEnum hKLocalAccountIdentificationTypeEnum)
                return Models.HKLocalAccountIdentification.TypeEnum.ToJsonValue(hKLocalAccountIdentificationTypeEnum);
            if (obj is Models.HULocalAccountIdentification.TypeEnum hULocalAccountIdentificationTypeEnum)
                return Models.HULocalAccountIdentification.TypeEnum.ToJsonValue(hULocalAccountIdentificationTypeEnum);
            if (obj is Models.IbanAccountIdentification.TypeEnum ibanAccountIdentificationTypeEnum)
                return Models.IbanAccountIdentification.TypeEnum.ToJsonValue(ibanAccountIdentificationTypeEnum);
            if (obj is Models.InternalCategoryData.TypeEnum internalCategoryDataTypeEnum)
                return Models.InternalCategoryData.TypeEnum.ToJsonValue(internalCategoryDataTypeEnum);
            if (obj is Models.InternalReviewTrackingData.StatusEnum internalReviewTrackingDataStatusEnum)
                return Models.InternalReviewTrackingData.StatusEnum.ToJsonValue(internalReviewTrackingDataStatusEnum);
            if (obj is Models.InternalReviewTrackingData.ReasonEnum internalReviewTrackingDataReasonEnum)
                return Models.InternalReviewTrackingData.ReasonEnum.ToJsonValue(internalReviewTrackingDataReasonEnum);
            if (obj is Models.InternalReviewTrackingData.TypeEnum internalReviewTrackingDataTypeEnum)
                return Models.InternalReviewTrackingData.TypeEnum.ToJsonValue(internalReviewTrackingDataTypeEnum);
            if (obj is Models.IssuedCard.PanEntryModeEnum issuedCardPanEntryModeEnum)
                return Models.IssuedCard.PanEntryModeEnum.ToJsonValue(issuedCardPanEntryModeEnum);
            if (obj is Models.IssuedCard.ProcessingTypeEnum issuedCardProcessingTypeEnum)
                return Models.IssuedCard.ProcessingTypeEnum.ToJsonValue(issuedCardProcessingTypeEnum);
            if (obj is Models.IssuedCard.TypeEnum issuedCardTypeEnum)
                return Models.IssuedCard.TypeEnum.ToJsonValue(issuedCardTypeEnum);
            if (obj is Models.IssuingTransactionData.TypeEnum issuingTransactionDataTypeEnum)
                return Models.IssuingTransactionData.TypeEnum.ToJsonValue(issuingTransactionDataTypeEnum);
            if (obj is Models.MerchantPurchaseData.TypeEnum merchantPurchaseDataTypeEnum)
                return Models.MerchantPurchaseData.TypeEnum.ToJsonValue(merchantPurchaseDataTypeEnum);
            if (obj is Models.Modification.StatusEnum modificationStatusEnum)
                return Models.Modification.StatusEnum.ToJsonValue(modificationStatusEnum);
            if (obj is Models.NOLocalAccountIdentification.TypeEnum nOLocalAccountIdentificationTypeEnum)
                return Models.NOLocalAccountIdentification.TypeEnum.ToJsonValue(nOLocalAccountIdentificationTypeEnum);
            if (obj is Models.NZLocalAccountIdentification.TypeEnum nZLocalAccountIdentificationTypeEnum)
                return Models.NZLocalAccountIdentification.TypeEnum.ToJsonValue(nZLocalAccountIdentificationTypeEnum);
            if (obj is Models.NumberAndBicAccountIdentification.TypeEnum numberAndBicAccountIdentificationTypeEnum)
                return Models.NumberAndBicAccountIdentification.TypeEnum.ToJsonValue(numberAndBicAccountIdentificationTypeEnum);
            if (obj is Models.PLLocalAccountIdentification.TypeEnum pLLocalAccountIdentificationTypeEnum)
                return Models.PLLocalAccountIdentification.TypeEnum.ToJsonValue(pLLocalAccountIdentificationTypeEnum);
            if (obj is Models.PartyIdentification.TypeEnum partyIdentificationTypeEnum)
                return Models.PartyIdentification.TypeEnum.ToJsonValue(partyIdentificationTypeEnum);
            if (obj is Models.PlatformPayment.PlatformPaymentTypeEnum platformPaymentPlatformPaymentTypeEnum)
                return Models.PlatformPayment.PlatformPaymentTypeEnum.ToJsonValue(platformPaymentPlatformPaymentTypeEnum);
            if (obj is Models.PlatformPayment.TypeEnum platformPaymentTypeEnum)
                return Models.PlatformPayment.TypeEnum.ToJsonValue(platformPaymentTypeEnum);
            if (obj is Models.SELocalAccountIdentification.TypeEnum sELocalAccountIdentificationTypeEnum)
                return Models.SELocalAccountIdentification.TypeEnum.ToJsonValue(sELocalAccountIdentificationTypeEnum);
            if (obj is Models.SGLocalAccountIdentification.TypeEnum sGLocalAccountIdentificationTypeEnum)
                return Models.SGLocalAccountIdentification.TypeEnum.ToJsonValue(sGLocalAccountIdentificationTypeEnum);
            if (obj is Models.TransferData.CategoryEnum transferDataCategoryEnum)
                return Models.TransferData.CategoryEnum.ToJsonValue(transferDataCategoryEnum);
            if (obj is Models.TransferData.StatusEnum transferDataStatusEnum)
                return Models.TransferData.StatusEnum.ToJsonValue(transferDataStatusEnum);
            if (obj is Models.TransferData.DirectionEnum transferDataDirectionEnum)
                return Models.TransferData.DirectionEnum.ToJsonValue(transferDataDirectionEnum);
            if (obj is Models.TransferData.ReasonEnum transferDataReasonEnum)
                return Models.TransferData.ReasonEnum.ToJsonValue(transferDataReasonEnum);
            if (obj is Models.TransferData.TypeEnum transferDataTypeEnum)
                return Models.TransferData.TypeEnum.ToJsonValue(transferDataTypeEnum);
            if (obj is Models.TransferEvent.ReasonEnum transferEventReasonEnum)
                return Models.TransferEvent.ReasonEnum.ToJsonValue(transferEventReasonEnum);
            if (obj is Models.TransferEvent.StatusEnum transferEventStatusEnum)
                return Models.TransferEvent.StatusEnum.ToJsonValue(transferEventStatusEnum);
            if (obj is Models.TransferEvent.TypeEnum transferEventTypeEnum)
                return Models.TransferEvent.TypeEnum.ToJsonValue(transferEventTypeEnum);
            if (obj is Models.TransferNotificationRequest.TypeEnum transferNotificationRequestTypeEnum)
                return Models.TransferNotificationRequest.TypeEnum.ToJsonValue(transferNotificationRequestTypeEnum);
            if (obj is Models.TransferReview.ScaOnApprovalEnum transferReviewScaOnApprovalEnum)
                return Models.TransferReview.ScaOnApprovalEnum.ToJsonValue(transferReviewScaOnApprovalEnum);
            if (obj is Models.UKLocalAccountIdentification.TypeEnum uKLocalAccountIdentificationTypeEnum)
                return Models.UKLocalAccountIdentification.TypeEnum.ToJsonValue(uKLocalAccountIdentificationTypeEnum);
            if (obj is Models.USLocalAccountIdentification.AccountTypeEnum uSLocalAccountIdentificationAccountTypeEnum)
                return Models.USLocalAccountIdentification.AccountTypeEnum.ToJsonValue(uSLocalAccountIdentificationAccountTypeEnum);
            if (obj is Models.USLocalAccountIdentification.TypeEnum uSLocalAccountIdentificationTypeEnum)
                return Models.USLocalAccountIdentification.TypeEnum.ToJsonValue(uSLocalAccountIdentificationTypeEnum);
            if (obj is ICollection collection)
            {
                List<string?> entries = new();
                foreach (var entry in collection)
                    entries.Add(ParameterToString(entry));
                return string.Join(",", entries);
            }

            return Convert.ToString(obj, System.Globalization.CultureInfo.InvariantCulture);
        }

        /// <summary>
        /// URL encode a string
        /// Credit/Ref: https://github.com/restsharp/RestSharp/blob/master/RestSharp/Extensions/StringExtensions.cs#L50
        /// </summary>
        /// <param name="input">string to be URL encoded</param>
        /// <returns>Byte array</returns>
        public static string UrlEncode(string input)
        {
            const int maxLength = 32766;

            if (input == null)
            {
                throw new ArgumentNullException("input");
            }

            if (input.Length <= maxLength)
            {
                return Uri.EscapeDataString(input);
            }

            StringBuilder sb = new StringBuilder(input.Length * 2);
            int index = 0;

            while (index < input.Length)
            {
                int length = Math.Min(input.Length - index, maxLength);
                string subString = input.Substring(index, length);

                sb.Append(Uri.EscapeDataString(subString));
                index += subString.Length;
            }

            return sb.ToString();
        }

        /// <summary>
        /// Encode string in base64 format.
        /// </summary>
        /// <param name="text">string to be encoded.</param>
        /// <returns>Encoded string.</returns>
        public static string Base64Encode(string text)
        {
            return Convert.ToBase64String(global::System.Text.Encoding.UTF8.GetBytes(text));
        }

        /// <summary>
        /// Convert stream to byte array
        /// </summary>
        /// <param name="inputStream">Input stream to be converted</param>
        /// <returns>Byte array</returns>
        public static byte[] ReadAsBytes(Stream inputStream)
        {
            using (var ms = new MemoryStream())
            {
                inputStream.CopyTo(ms);
                return ms.ToArray();
            }
        }

        /// <summary>
        /// Select the Content-Type header's value from the given content-type array:
        /// if JSON type exists in the given array, use it;
        /// otherwise use the first one defined in 'consumes'
        /// </summary>
        /// <param name="contentTypes">The Content-Type array to select from.</param>
        /// <returns>The Content-Type header to use.</returns>
        public static string? SelectHeaderContentType(string[] contentTypes)
        {
            if (contentTypes.Length == 0)
                return null;

            foreach (var contentType in contentTypes)
            {
                if (IsJsonMime(contentType))
                    return contentType;
            }

            return contentTypes[0]; // use the first content type specified in 'consumes'
        }

        /// <summary>
        /// Select the Accept header's value from the given accepts array:
        /// if JSON exists in the given array, use it;
        /// otherwise use all of them (joining into a string)
        /// </summary>
        /// <param name="accepts">The accepts array to select from.</param>
        /// <returns>The Accept header to use.</returns>
        public static string? SelectHeaderAccept(string[] accepts)
        {
            if (accepts.Length == 0)
                return null;

            if (accepts.Contains("application/json", StringComparer.OrdinalIgnoreCase))
                return "application/json";

            return string.Join(",", accepts);
        }
                        
        /// <summary>
        /// Check if the given MIME is a JSON MIME.
        /// JSON MIME examples:
        ///    application/json
        ///    application/json; charset=UTF8
        ///    APPLICATION/JSON
        /// </summary>
        /// <param name="mime">MIME</param>
        /// <returns>Returns True if MIME type is json.</returns>
        public static bool IsJsonMime(string mime)
        {
            if (string.IsNullOrWhiteSpace(mime))
                return false;

            // Remove parameters (e.g. "; charset=utf-8")
            int index = mime.IndexOf(';');
            if (index >= 0)
                mime = mime.Substring(0, index);

            mime = mime.Trim();

            return mime.Equals("application/json", StringComparison.OrdinalIgnoreCase) || mime.Equals("application/json-patch+json", StringComparison.OrdinalIgnoreCase);
        }

        /// <summary>
        /// Get the discriminator
        /// </summary>
        /// <param name="utf8JsonReader"></param>
        /// <param name="discriminator"></param>
        /// <returns></returns>
        /// <exception cref="JsonException"></exception>
        public static string? GetDiscriminator(Utf8JsonReader utf8JsonReader, string discriminator)
        {
            int currentDepth = utf8JsonReader.CurrentDepth;

            if (utf8JsonReader.TokenType != JsonTokenType.StartObject && utf8JsonReader.TokenType != JsonTokenType.StartArray)
                throw new JsonException();

            JsonTokenType startingTokenType = utf8JsonReader.TokenType;

            while (utf8JsonReader.Read())
            {
                if (startingTokenType == JsonTokenType.StartObject && utf8JsonReader.TokenType == JsonTokenType.EndObject && currentDepth == utf8JsonReader.CurrentDepth)
                    break;

                if (startingTokenType == JsonTokenType.StartArray && utf8JsonReader.TokenType == JsonTokenType.EndArray && currentDepth == utf8JsonReader.CurrentDepth)
                    break;

                if (utf8JsonReader.TokenType == JsonTokenType.PropertyName && currentDepth == utf8JsonReader.CurrentDepth - 1)
                {
                    string? jsonPropertyName = utf8JsonReader.GetString();
                    utf8JsonReader.Read();

                    if (jsonPropertyName != null && jsonPropertyName.Equals(discriminator))
                        return utf8JsonReader.GetString();
                }
            }

            throw new JsonException("The specified discriminator was not found.");
        }
                        
    }
}
