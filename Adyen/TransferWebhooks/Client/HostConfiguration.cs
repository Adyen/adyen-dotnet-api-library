/*
 * Transfer webhooks
 *
 * Adyen sends webhooks to inform your system about incoming and outgoing transfers in your platform.  You can use these webhooks to build your implementation. For example, you can use this information to update balances in your own dashboards or to keep track of incoming funds.
 *
 * The version of the OpenAPI document: 4
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

#nullable enable

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Net.Http;
using Microsoft.Extensions.DependencyInjection;

using Adyen.TransferWebhooks.Client;
using Adyen.TransferWebhooks.Models;
using Adyen.Core;
using Adyen.Core.Auth;
using Adyen.Core.Client;
using Adyen.Core.Options;
using Adyen.Core.Converters;

namespace Adyen.TransferWebhooks.Client
{
    /// <summary>
    /// Provides hosting configuration for TransferWebhooks
    /// </summary>
    public class HostConfiguration
    {
        private readonly IServiceCollection _services;
        private readonly JsonSerializerOptions _jsonOptions = new JsonSerializerOptions();
        private readonly AdyenOptions _adyenOptions = new AdyenOptions();

        internal bool HttpClientsAdded { get; private set; }
        
        /// <summary>
        /// The base path of the API, it includes the http(s)-scheme, the host domain name, and the base path.
        /// This value can change when `ConfigureAdyenOptions` is called in <see cref="HostConfiguration"/>). The new value will be based on the <see cref="AdyenOptions"/>.<see cref="AdyenEnvironment"/>.
        /// </summary>
        public static string BASE_URL = "http://localhost";

        /// <summary>
        /// The relative path of the API after the `.com`.
        /// </summary>
        public static string RELATIVE_URL = "";
        
        /// <summary>
        /// Instantiates the HostConfiguration (custom JsonConverters, Events, HttpClient) with the necessary dependencies to communicate with the API.
        /// </summary>
        /// <param name="services"><see cref="IServiceCollection"/></param>
        public HostConfiguration(IServiceCollection services)
        {
            _services = services;
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(JsonStringEnumConverter)) == null)
                _jsonOptions.Converters.Add(new JsonStringEnumConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateTimeJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateTimeJsonConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateTimeNullableJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateTimeNullableJsonConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateOnlyJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateOnlyJsonConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateOnlyNullableJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateOnlyNullableJsonConverter());
            _jsonOptions.Converters.Add(new AULocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalBankIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new AddressJsonConverter());
            _jsonOptions.Converters.Add(new AirlineJsonConverter());
            _jsonOptions.Converters.Add(new AmountJsonConverter());
            _jsonOptions.Converters.Add(new AmountAdjustmentJsonConverter());
            _jsonOptions.Converters.Add(new BRLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new BalanceMutationJsonConverter());
            _jsonOptions.Converters.Add(new BalancePlatformNotificationResponseJsonConverter());
            _jsonOptions.Converters.Add(new BankAccountV3JsonConverter());
            _jsonOptions.Converters.Add(new BankAccountV3AccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new BankCategoryDataJsonConverter());
            _jsonOptions.Converters.Add(new CALocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new CZLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new CardJsonConverter());
            _jsonOptions.Converters.Add(new CardIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new ConfirmationTrackingDataJsonConverter());
            _jsonOptions.Converters.Add(new CounterpartyV3JsonConverter());
            _jsonOptions.Converters.Add(new DKLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new DirectDebitInformationJsonConverter());
            _jsonOptions.Converters.Add(new EstimationTrackingDataJsonConverter());
            _jsonOptions.Converters.Add(new ExecutionDateJsonConverter());
            _jsonOptions.Converters.Add(new ExternalReasonJsonConverter());
            _jsonOptions.Converters.Add(new HKLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new HULocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new IbanAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new InternalCategoryDataJsonConverter());
            _jsonOptions.Converters.Add(new InternalReviewTrackingDataJsonConverter());
            _jsonOptions.Converters.Add(new IssuedCardJsonConverter());
            _jsonOptions.Converters.Add(new IssuingTransactionDataJsonConverter());
            _jsonOptions.Converters.Add(new LegJsonConverter());
            _jsonOptions.Converters.Add(new LodgingJsonConverter());
            _jsonOptions.Converters.Add(new MerchantDataJsonConverter());
            _jsonOptions.Converters.Add(new MerchantPurchaseDataJsonConverter());
            _jsonOptions.Converters.Add(new ModificationJsonConverter());
            _jsonOptions.Converters.Add(new NOLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new NZLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new NameLocationJsonConverter());
            _jsonOptions.Converters.Add(new NumberAndBicAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new PLLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new PartyIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new PaymentInstrumentJsonConverter());
            _jsonOptions.Converters.Add(new PlatformPaymentJsonConverter());
            _jsonOptions.Converters.Add(new RelayedAuthorisationDataJsonConverter());
            _jsonOptions.Converters.Add(new ResourceJsonConverter());
            _jsonOptions.Converters.Add(new ResourceReferenceJsonConverter());
            _jsonOptions.Converters.Add(new SELocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new SGLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new ThreeDSecureJsonConverter());
            _jsonOptions.Converters.Add(new TransactionEventViolationJsonConverter());
            _jsonOptions.Converters.Add(new TransactionRuleReferenceJsonConverter());
            _jsonOptions.Converters.Add(new TransactionRuleSourceJsonConverter());
            _jsonOptions.Converters.Add(new TransactionRulesResultJsonConverter());
            _jsonOptions.Converters.Add(new TransferDataJsonConverter());
            _jsonOptions.Converters.Add(new TransferDataCategoryDataJsonConverter());
            _jsonOptions.Converters.Add(new TransferDataTrackingJsonConverter());
            _jsonOptions.Converters.Add(new TransferEventJsonConverter());
            _jsonOptions.Converters.Add(new TransferEventEventsDataInnerJsonConverter());
            _jsonOptions.Converters.Add(new TransferEventTrackingDataJsonConverter());
            _jsonOptions.Converters.Add(new TransferNotificationCounterPartyJsonConverter());
            _jsonOptions.Converters.Add(new TransferNotificationMerchantDataJsonConverter());
            _jsonOptions.Converters.Add(new TransferNotificationRequestJsonConverter());
            _jsonOptions.Converters.Add(new TransferNotificationValidationFactJsonConverter());
            _jsonOptions.Converters.Add(new TransferReviewJsonConverter());
            _jsonOptions.Converters.Add(new UKLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new USLocalAccountIdentificationJsonConverter());
            JsonSerializerOptionsProvider jsonSerializerOptionsProvider = new(_jsonOptions);
            _services.AddSingleton(jsonSerializerOptionsProvider);
            _services.AddSingleton<IApiFactory, ApiFactory>();
        }

        /// <summary>
        /// Configures the HttpClients.
        /// </summary>
        /// <param name="clientAction"></param>
        /// <param name="builderAction"></param>
        /// <returns><see cref="HostConfiguration"/></returns>
        public HostConfiguration AddTransferWebhooksHttpClients(Action<System.Net.Http.HttpClient>? clientAction = null, Action<IHttpClientBuilder>? builderAction = null)
        {
            if (clientAction == null)
                clientAction = httpClient => httpClient.BaseAddress = new Uri(ConstructHostUrl());

            List<IHttpClientBuilder> builders = new List<IHttpClientBuilder>();

            
            if (builderAction != null)
                foreach (IHttpClientBuilder instance in builders)
                    builderAction(instance);

            HttpClientsAdded = true;

            return this;
        }

        /// <summary>
        /// Configures the <see cref="JsonSerializerOptions"/>.
        /// </summary>
        /// <param name="optionsAction"></param>
        /// <returns><see cref="HostConfiguration"/></returns>
        public HostConfiguration ConfigureJsonOptions(Action<JsonSerializerOptions> optionsAction)
        {
            optionsAction(_jsonOptions);
            
            return this;
        }

        /// <summary>
        /// Configures the Adyen Settings, e.g. Environment, LiveEndpointPrefix and more.
        /// </summary>
        /// <param name="optionsAction"></param>
        /// <returns></returns>
        public HostConfiguration ConfigureAdyenOptions(Action<AdyenOptions> optionsAction)
        {
            optionsAction(_adyenOptions);
            return this;
        }

        /// <summary>
        /// Constructs the Host URL based on the selected <see cref="AdyenEnvironment"/>, used to populate the `HttpClient.BaseAddress`.
        /// </summary>
        /// <returns>String with the Host URL.</returns>
        /// <exception cref="ArgumentOutOfRangeException"></exception>
        private string ConstructHostUrl()
        {
            if (_adyenOptions.Environment == AdyenEnvironment.Live)
                return ConstructLiveUrl(_adyenOptions.LiveEndpointUrlPrefix, BASE_URL);
            
            // Some Adyen OpenApi Specifications use the live-url, instead of the test-url, this line replaces "-live" with "-test".
            // If you need to override this URL, you can do so by replacing the BASE_URL in ClientUtils.cs.
            if (_adyenOptions.Environment == AdyenEnvironment.Test)
                return BASE_URL.Replace("-live", "-test");
            
            throw new ArgumentOutOfRangeException(_adyenOptions.Environment.ToString());
        }
        
        /// <summary>
        /// Construct LIVE BaseUrl, add the liveEndpointUrlPrefix it's the Checkout API or the Classic Payment API.
        /// This helper function can be removed when all URLs (test & live) are included in the Adyen OpenApi Specifications: https://github.com/Adyen/adyen-openapi.
        /// </summary>
        /// <param name="liveEndpointUrlPrefix">The Live EndpointUrlPrefix.</param>
        /// <param name="url">The Base URL <see cref="BASE_URL"/>.</param>
        /// <returns>baseUrl</returns>
        /// <exception cref="InvalidOperationException"></exception>
        private string ConstructLiveUrl(string liveEndpointUrlPrefix, string url)
        {
            // Change base url for Live environment
            if (url.Contains("pal-")) // Payment API prefix
            {
                if (liveEndpointUrlPrefix == null)
                {
                    throw new InvalidOperationException("LiveEndpointUrlPrefix is null - please configure your AdyenOptions.LiveEndpointUrlPrefix");
                }
                
                url = url.Replace("https://pal-test.adyen.com/pal/servlet/",
                    "https://" + liveEndpointUrlPrefix + "-pal-live.adyenpayments.com/pal/servlet/");
            }
            else if (url.Contains("checkout-")) // Checkout API prefix
            {
                if (liveEndpointUrlPrefix == null)
                {
                    throw new InvalidOperationException("LiveEndpointUrlPrefix is null - please configure your AdyenOptions.LiveEndpointUrlPrefix");
                }

                if (url.Contains("possdk"))
                {
                    url = url.Replace("https://checkout-test.adyen.com/",
                        "https://" + liveEndpointUrlPrefix + "-checkout-live.adyenpayments.com/");   
                }
                else
                {
                    url = url.Replace("https://checkout-test.adyen.com/",
                        "https://" + liveEndpointUrlPrefix + "-checkout-live.adyenpayments.com/checkout/");
                }
            }
            
            // If no prefix is required, we replace "test" -> "live"
            url = url.Replace("-test", "-live");
            return url;
        }
    }
}
