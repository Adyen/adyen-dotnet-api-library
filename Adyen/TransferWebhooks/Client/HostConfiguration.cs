/*
 * Transfer webhooks
 *
 * Adyen sends webhooks to inform your system about incoming and outgoing transfers in your platform.  You can use these webhooks to build your implementation. For example, you can use this information to update balances in your own dashboards or to keep track of incoming funds.
 *
 * The version of the OpenAPI document: 4
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

#nullable enable

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Net.Http;
using Microsoft.Extensions.DependencyInjection;

using Adyen.TransferWebhooks.Client;
using Adyen.TransferWebhooks.Models;
using Adyen.TransferWebhooks.Extensions;
using Adyen.Core;
using Adyen.Core.Auth;
using Adyen.Core.Client;
using Adyen.Core.Options;
using Adyen.Core.Converters;

namespace Adyen.TransferWebhooks.Client
{
    /// <summary>
    /// Provides hosting configuration for TransferWebhooks
    /// </summary>
    public class HostConfiguration
    {
        private readonly IServiceCollection _services;
        private readonly JsonSerializerOptions _jsonOptions = new JsonSerializerOptions();
        private readonly AdyenOptions _adyenOptions = new AdyenOptions();

        /// <summary>
        /// Instantiates the HostConfiguration (custom JsonConverters, Events, HttpClient) with the necessary dependencies to communicate with the API.
        /// </summary>
        /// <param name="services"><see cref="IServiceCollection"/></param>
        public HostConfiguration(IServiceCollection services)
        {
            _services = services;
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(JsonStringEnumConverter)) == null)
                _jsonOptions.Converters.Add(new JsonStringEnumConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateTimeJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateTimeJsonConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateTimeNullableJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateTimeNullableJsonConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(ByteArrayConverter)) == null)
                _jsonOptions.Converters.Add(new ByteArrayConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateOnlyJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateOnlyJsonConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateOnlyNullableJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateOnlyNullableJsonConverter());
            _jsonOptions.Converters.Add(new AULocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalBankIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new AddressJsonConverter());
            _jsonOptions.Converters.Add(new AirlineJsonConverter());
            _jsonOptions.Converters.Add(new AmountJsonConverter());
            _jsonOptions.Converters.Add(new AmountAdjustmentJsonConverter());
            _jsonOptions.Converters.Add(new BRLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new BalanceMutationJsonConverter());
            _jsonOptions.Converters.Add(new BalancePlatformNotificationResponseJsonConverter());
            _jsonOptions.Converters.Add(new BankAccountV3JsonConverter());
            _jsonOptions.Converters.Add(new BankAccountV3AccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new BankCategoryDataJsonConverter());
            _jsonOptions.Converters.Add(new CALocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new CZLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new CardJsonConverter());
            _jsonOptions.Converters.Add(new CardIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new ConfirmationTrackingDataJsonConverter());
            _jsonOptions.Converters.Add(new CounterpartyV3JsonConverter());
            _jsonOptions.Converters.Add(new DKLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new DirectDebitInformationJsonConverter());
            _jsonOptions.Converters.Add(new EstimationTrackingDataJsonConverter());
            _jsonOptions.Converters.Add(new ExecutionDateJsonConverter());
            _jsonOptions.Converters.Add(new ExternalReasonJsonConverter());
            _jsonOptions.Converters.Add(new HKLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new HULocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new IbanAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new InterchangeDataJsonConverter());
            _jsonOptions.Converters.Add(new InternalCategoryDataJsonConverter());
            _jsonOptions.Converters.Add(new InternalReviewTrackingDataJsonConverter());
            _jsonOptions.Converters.Add(new IssuedCardJsonConverter());
            _jsonOptions.Converters.Add(new IssuingTransactionDataJsonConverter());
            _jsonOptions.Converters.Add(new LegJsonConverter());
            _jsonOptions.Converters.Add(new LodgingJsonConverter());
            _jsonOptions.Converters.Add(new MerchantDataJsonConverter());
            _jsonOptions.Converters.Add(new MerchantPurchaseDataJsonConverter());
            _jsonOptions.Converters.Add(new ModificationJsonConverter());
            _jsonOptions.Converters.Add(new NOLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new NZLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new NameLocationJsonConverter());
            _jsonOptions.Converters.Add(new NumberAndBicAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new PLLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new PartyIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new PaymentInstrumentJsonConverter());
            _jsonOptions.Converters.Add(new PlatformPaymentJsonConverter());
            _jsonOptions.Converters.Add(new RelayedAuthorisationDataJsonConverter());
            _jsonOptions.Converters.Add(new ResourceJsonConverter());
            _jsonOptions.Converters.Add(new ResourceReferenceJsonConverter());
            _jsonOptions.Converters.Add(new SELocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new SGLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new ThreeDSecureJsonConverter());
            _jsonOptions.Converters.Add(new TransactionEventViolationJsonConverter());
            _jsonOptions.Converters.Add(new TransactionRuleReferenceJsonConverter());
            _jsonOptions.Converters.Add(new TransactionRuleSourceJsonConverter());
            _jsonOptions.Converters.Add(new TransactionRulesResultJsonConverter());
            _jsonOptions.Converters.Add(new TransferDataJsonConverter());
            _jsonOptions.Converters.Add(new TransferDataCategoryDataJsonConverter());
            _jsonOptions.Converters.Add(new TransferDataTrackingJsonConverter());
            _jsonOptions.Converters.Add(new TransferEventJsonConverter());
            _jsonOptions.Converters.Add(new TransferEventEventsDataInnerJsonConverter());
            _jsonOptions.Converters.Add(new TransferEventTrackingDataJsonConverter());
            _jsonOptions.Converters.Add(new TransferNotificationCounterPartyJsonConverter());
            _jsonOptions.Converters.Add(new TransferNotificationMerchantDataJsonConverter());
            _jsonOptions.Converters.Add(new TransferNotificationRequestJsonConverter());
            _jsonOptions.Converters.Add(new TransferNotificationValidationFactJsonConverter());
            _jsonOptions.Converters.Add(new TransferReviewJsonConverter());
            _jsonOptions.Converters.Add(new UKLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new USLocalAccountIdentificationJsonConverter());
            JsonSerializerOptionsProvider jsonSerializerOptionsProvider = new(_jsonOptions);
            _services.AddSingleton(jsonSerializerOptionsProvider);
        }

        /// <summary>
        /// Configures the <see cref="JsonSerializerOptions"/>.
        /// </summary>
        /// <param name="jsonSerializerOptions">Configures the <see cref="JsonSerializerOptions"/>.</param>
        /// <returns><see cref="HostConfiguration"/>.</returns>
        public HostConfiguration ConfigureJsonOptions(Action<JsonSerializerOptions> jsonSerializerOptions)
        {
            jsonSerializerOptions(_jsonOptions);
            return this;
        }

        /// <summary>
        /// Configures the <see cref="AdyenOptions"/> (e.g. Environment, LiveEndpointPrefix, <see cref="ITokenProvider{ApiKeyToken}"/>).
        /// </summary>
        /// <param name="adyenOptions">Configures the <see cref="AdyenOptions"/>.</param>
        /// <returns><see cref="HostConfiguration"/>.</returns>
        public HostConfiguration ConfigureAdyenOptions(Action<AdyenOptions> adyenOptions)
        {
            adyenOptions(_adyenOptions);
            _services.AddSingleton(new AdyenOptionsProvider(_adyenOptions));
                    
             _services.AddSingleton<ITokenProvider<HmacKeyToken>>(new TokenProvider<HmacKeyToken>(new HmacKeyToken(_adyenOptions.AdyenHmacKey)));
            return this;
        }
    }
}
