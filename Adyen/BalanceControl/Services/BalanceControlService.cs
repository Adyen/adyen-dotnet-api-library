// <auto-generated>
/*
 * Adyen Balance Control API
 *
 * The Balance Control API lets you transfer funds between merchant accounts that belong to the same legal entity and are under the same company account.  ## Authentication To connect to the Balance Control API, you must authenticate your requests with an [API key or basic auth username and password](https://docs.adyen.com/development-resources/api-authentication). To learn how you can generate these, see [API credentials](https://docs.adyen.com/development-resources/api-credentials).Here is an example of authenticating a request with an API key:  ``` curl -H \"X-API-Key: Your_API_key\" \\ -H \"Content-Type: application/json\" \\ ... ``` Note that when going live, you need to generate API credentials to access the [live endpoints](https://docs.adyen.com/development-resources/live-endpoints).  ## Versioning The Balance Control API supports [versioning](https://docs.adyen.com/development-resources/versioning) using a version suffix in the endpoint URL. This suffix has the following format: \"vXX\", where XX is the version number.  For example:  ``` https://pal-test.adyen.com/pal/servlet/BalanceControl/v1/balanceTransfer ``` 
 *
 * The version of the OpenAPI document: 1
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

#nullable enable

using System;
using System.Collections.Generic;
using System.Net;
using System.Threading.Tasks;
using Microsoft.Extensions.Logging;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Text.Json;
using Adyen.Core;
using Adyen.Core.Auth;
using Adyen.Core.Client;
using Adyen.Core.Client.Extensions;
using Adyen.BalanceControl.Client;
using Adyen.BalanceControl.Models;
using System.Diagnostics.CodeAnalysis;

namespace Adyen.BalanceControl.Services
{
    /// <summary>
    /// Represents a collection of functions to interact with the API endpoints.
    /// This class is registered as transient.
    /// </summary>
    public interface IBalanceControlService : IAdyenApiService
    {
        /// <summary>
        /// The class containing the events.
        /// </summary>
        BalanceControlServiceEvents Events { get; }

        /// <summary>
        /// Start a balance transfer
        /// </summary>
        /// <remarks>
        /// Starts a balance transfer request between merchant accounts. The following conditions must be met before you can successfully transfer balances:  * The source and destination merchant accounts must be under the same company account and legal entity.  * The source merchant account must have sufficient funds.  * The source and destination merchant accounts must have at least one common processing currency.  When sending multiple API requests with the same source and destination merchant accounts, send the requests sequentially and *not* in parallel. Some requests may not be processed if the requests are sent in parallel. 
        /// </remarks>
        /// <exception cref="ApiException">Thrown when fails to make API call.</exception>
        /// <param name="balanceTransferRequest"></param>
        /// <param name="requestOptions"><see cref="RequestOptions"/>.</param>
        /// <param name="cancellationToken"><see cref="CancellationToken"/>.</param>
        /// <returns><see cref="Task"/> of <see cref="IBalanceTransferApiResponse"/>.</returns>
        [Obsolete("Deprecated since Adyen Balance Control API v1.")]
        Task<IBalanceTransferApiResponse> BalanceTransferAsync(Option<BalanceTransferRequest> balanceTransferRequest = default, RequestOptions? requestOptions = default, System.Threading.CancellationToken cancellationToken = default);

    }

    /// <summary>
    /// The <see cref="IBalanceTransferApiResponse"/>.
    /// // Usage: Use `TryDeserializeOk(out var result)` to get the result from the API:
    /// <see cref="Adyen.BalanceControl.Models.BalanceTransferResponse"/>.
    /// </summary>
    public interface IBalanceTransferApiResponse : Adyen.Core.Client.IApiResponse, IOk<Adyen.BalanceControl.Models.BalanceTransferResponse?>
    {
        /// <summary>
        /// Returns true if the response is 200 Ok.
        /// </summary>
        /// <returns></returns>
        bool IsOk { get; }
    }

    /// <summary>
    /// Represents a collection of functions to interact with the API endpoints.
    /// </summary>
    public class BalanceControlServiceEvents
    {
        /// <summary>
        /// The event raised after the server response.
        /// </summary>
        public event EventHandler<ApiResponseEventArgs>? OnBalanceTransfer;

        /// <summary>
        /// The event raised after an error querying the server.
        /// </summary>
        public event EventHandler<ExceptionEventArgs>? OnErrorBalanceTransfer;

        internal void ExecuteOnBalanceTransfer(BalanceControlService.BalanceTransferApiResponse apiResponse)
        {
            OnBalanceTransfer?.Invoke(this, new ApiResponseEventArgs(apiResponse));
        }

        internal void ExecuteOnErrorBalanceTransfer(Exception exception)
        {
            OnErrorBalanceTransfer?.Invoke(this, new ExceptionEventArgs(exception));
        }
    }

    /// <summary>
    /// Represents a collection of functions to interact with the API endpoints.
    /// </summary>
    public sealed partial class BalanceControlService : IBalanceControlService
    {
        private JsonSerializerOptions _jsonSerializerOptions;

        /// <summary>
        /// The logger factory.
        /// </summary>
        public ILoggerFactory LoggerFactory { get; }

        /// <summary>
        /// The logger.
        /// </summary>
        public ILogger<BalanceControlService> Logger { get; }

        /// <summary>
        /// The HttpClient.
        /// </summary>
        public System.Net.Http.HttpClient HttpClient { get; }

        /// <summary>
        /// The class containing the events.
        /// </summary>
        public BalanceControlServiceEvents Events { get; }

        /// <summary>
        /// A token provider of type <see cref="ApiKeyProvider"/>.
        /// </summary>
        public ITokenProvider<ApiKeyToken> ApiKeyProvider { get; }

        /// <summary>
        /// Initializes a new instance of the <see cref="BalanceControlService"/> class.
        /// </summary>
        public BalanceControlService(ILogger<BalanceControlService> logger, ILoggerFactory loggerFactory, System.Net.Http.HttpClient httpClient, JsonSerializerOptionsProvider jsonSerializerOptionsProvider, BalanceControlServiceEvents balanceControlServiceEvents,
            ITokenProvider<ApiKeyToken> apiKeyProvider)
        {
            _jsonSerializerOptions = jsonSerializerOptionsProvider.Options;
            LoggerFactory = loggerFactory;
            Logger = logger == null ? LoggerFactory.CreateLogger<BalanceControlService>() : logger;
            HttpClient = httpClient;
            Events = balanceControlServiceEvents;
            ApiKeyProvider = apiKeyProvider;
        }
        
        /// <summary>
        /// Start a balance transfer Starts a balance transfer request between merchant accounts. The following conditions must be met before you can successfully transfer balances:  * The source and destination merchant accounts must be under the same company account and legal entity.  * The source merchant account must have sufficient funds.  * The source and destination merchant accounts must have at least one common processing currency.  When sending multiple API requests with the same source and destination merchant accounts, send the requests sequentially and *not* in parallel. Some requests may not be processed if the requests are sent in parallel. 
        /// </summary>
        /// <example>
        /// Use TryDeserializeOk(out <see cref="Adyen.BalanceControl.Models.BalanceTransferResponse"/> result) to retrieve the API result, when 200 OK response.
        /// </example>
        /// <code>
        /// // Usage:
        /// var response = await BalanceTransferAsync(...);
        /// if (response.TryDeserializeOk(out <see cref="Adyen.BalanceControl.Models.BalanceTransferResponse"/> result));
        /// </code>
        /// <exception cref="ApiException">Thrown when fails to make API call.</exception>
        /// <param name="balanceTransferRequest"><see cref="BalanceTransferRequest"/> (optional)</param>
        /// <param name="requestOptions"><see cref="RequestOptions"/>.</param>
        /// <param name="cancellationToken"><see cref="CancellationToken"/>.</param>
        /// <returns><see cref="Task"/> of <see cref="IBalanceTransferApiResponse"/> - If 200 OK response wraps the <see cref="Adyen.BalanceControl.Models.BalanceTransferResponse"/> when `TryDeserializeOk(...)` is called.</returns>
        public async Task<IBalanceTransferApiResponse> BalanceTransferAsync(Option<BalanceTransferRequest> balanceTransferRequest = default, RequestOptions? requestOptions = default, System.Threading.CancellationToken cancellationToken = default)
        {
            UriBuilder uriBuilder = new UriBuilder();

            try
            {
                using (HttpRequestMessage httpRequestMessage = new HttpRequestMessage())
                {
                    uriBuilder.Host = HttpClient.BaseAddress!.Host;
                    uriBuilder.Port = HttpClient.BaseAddress.Port;
                    uriBuilder.Scheme = HttpClient.BaseAddress.Scheme;
                    uriBuilder.Path = HttpClient.BaseAddress.AbsolutePath == "/"
                        ? "/balanceTransfer"
                        : string.Concat(HttpClient.BaseAddress.AbsolutePath, "/balanceTransfer");

                    // Adds headers to the HttpRequestMessage header, these can be set in the RequestOptions (Idempotency-Key etc.)
                    requestOptions?.AddHeadersToHttpRequestMessage(httpRequestMessage);
                    if (balanceTransferRequest.IsSet)
                        httpRequestMessage.Content = (balanceTransferRequest.Value as object) is System.IO.Stream stream
                            ? httpRequestMessage.Content = new StreamContent(stream)
                            : httpRequestMessage.Content = new StringContent(JsonSerializer.Serialize(balanceTransferRequest.Value, _jsonSerializerOptions));

                    // Add authorization token to the HttpRequestMessage header
                    ApiKeyProvider.Get().AddTokenToHttpRequestMessageHeader(httpRequestMessage);
                    
                    httpRequestMessage.RequestUri = uriBuilder.Uri;

                    string[] contentTypes = new string[] {
                        "application/json"
                    };

                    httpRequestMessage.AddUserAgentToHeaders();
                    httpRequestMessage.AddLibraryNameToHeader();
                    httpRequestMessage.AddLibraryVersionToHeader();
                    
                    string? contentType = ClientUtils.SelectHeaderContentType(contentTypes);

                    if (contentType != null && httpRequestMessage.Content != null)
                        httpRequestMessage.Content.Headers.ContentType = new MediaTypeHeaderValue(contentType);

                    string[] accepts = new string[] {
                        "application/json"
                    };

                    string? accept = ClientUtils.SelectHeaderAccept(accepts);

                    if (accept != null)
                        httpRequestMessage.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue(accept));

                    httpRequestMessage.Method = HttpMethod.Post;

                    DateTime requestedAt = DateTime.UtcNow;

                    using (HttpResponseMessage httpResponseMessage = await HttpClient.SendAsync(httpRequestMessage, cancellationToken).ConfigureAwait(false))
                    {
                        ILogger<BalanceTransferApiResponse> apiResponseLogger = LoggerFactory.CreateLogger<BalanceTransferApiResponse>();
                        BalanceTransferApiResponse apiResponse;

                        switch ((int)httpResponseMessage.StatusCode) {
                            default: {
                                string responseContent = await httpResponseMessage.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false);
                                apiResponse = new(apiResponseLogger, httpRequestMessage, httpResponseMessage, responseContent, "/balanceTransfer", requestedAt, _jsonSerializerOptions);

                                break;
                            }
                        }
                        
                        Events.ExecuteOnBalanceTransfer(apiResponse);
                        return apiResponse;
                    }
                }
            }
            catch(Exception exception)
            {
                Events.ExecuteOnErrorBalanceTransfer(exception);
                throw;
            }
        }

        /// <summary>
        /// The <see cref="BalanceTransferApiResponse"/>.
        /// </summary>
        public partial class BalanceTransferApiResponse : Adyen.Core.Client.ApiResponse, IBalanceTransferApiResponse
        {
            /// <summary>
            /// The logger for <see cref="BalanceTransferApiResponse"/>.
            /// </summary>
            public ILogger<BalanceTransferApiResponse> Logger { get; }

            /// <summary>
            /// The <see cref="BalanceTransferApiResponse"/>.
            /// </summary>
            /// <param name="logger"><see cref="ILogger"/>.</param>
            /// <param name="httpRequestMessage"><see cref="System.Net.Http.HttpRequestMessage"/>.</param>
            /// <param name="httpResponseMessage"><see cref="System.Net.Http.HttpResponseMessage"/>.</param>
            /// <param name="rawContent">The raw data.</param>
            /// <param name="path">The path used when making the request.</param>
            /// <param name="requestedAt">The DateTime.UtcNow when the request was retrieved.</param>
            /// <param name="jsonSerializerOptions"><see cref="JsonSerializerOptionsProvider"/></param>
            public BalanceTransferApiResponse(ILogger<BalanceTransferApiResponse> logger, System.Net.Http.HttpRequestMessage httpRequestMessage, System.Net.Http.HttpResponseMessage httpResponseMessage, string rawContent, string path, DateTime requestedAt, System.Text.Json.JsonSerializerOptions jsonSerializerOptions) : base(httpRequestMessage, httpResponseMessage, rawContent, path, requestedAt, jsonSerializerOptions)
            {
                Logger = logger;
                OnCreated(httpRequestMessage, httpResponseMessage);
            }

            /// <summary>
            /// The <see cref="BalanceTransferApiResponse"/>.
            /// </summary>
            /// <param name="logger"><see cref="ILogger"/>.</param>
            /// <param name="httpRequestMessage"><see cref="System.Net.Http.HttpRequestMessage"/>.</param>
            /// <param name="httpResponseMessage"><see cref="System.Net.Http.HttpResponseMessage"/>.</param>
            /// <param name="contentStream">The raw binary stream (only set for binary responses).</param>
            /// <param name="path">The path used when making the request.</param>
            /// <param name="requestedAt">The DateTime.UtcNow when the request was retrieved.</param>
            /// <param name="jsonSerializerOptions"><see cref="JsonSerializerOptionsProvider"/></param>
            public BalanceTransferApiResponse(ILogger<BalanceTransferApiResponse> logger, System.Net.Http.HttpRequestMessage httpRequestMessage, System.Net.Http.HttpResponseMessage httpResponseMessage, System.IO.Stream contentStream, string path, DateTime requestedAt, System.Text.Json.JsonSerializerOptions jsonSerializerOptions) : base(httpRequestMessage, httpResponseMessage, contentStream, path, requestedAt, jsonSerializerOptions)
            {
                Logger = logger;
                OnCreated(httpRequestMessage, httpResponseMessage);
            }

            partial void OnCreated(global::System.Net.Http.HttpRequestMessage httpRequestMessage, System.Net.Http.HttpResponseMessage httpResponseMessage);

            /// <summary>
            /// Returns true if the response is 200 Ok.
            /// </summary>
            /// <returns></returns>
            public bool IsOk => 200 == (int)StatusCode;

            /// <summary>
            /// Deserializes the response if the response is 200 Ok.
            /// </summary>
            /// <returns></returns>
            public Adyen.BalanceControl.Models.BalanceTransferResponse? Ok()
            {
                return IsOk
                    ? System.Text.Json.JsonSerializer.Deserialize<Adyen.BalanceControl.Models.BalanceTransferResponse>(RawContent, _jsonSerializerOptions)
                    : null;
            }

            /// <summary>
            /// Returns true if the response is 200 Ok and the deserialized response is not null.
            /// </summary>
            /// <param name="result"></param>
            /// <returns></returns>
            public bool TryDeserializeOkResponse([NotNullWhen(true)]out Adyen.BalanceControl.Models.BalanceTransferResponse? result)
            {
                result = null;

                try
                {
                    result = Ok();
                } 
                catch (Exception exception)
                {
                    OnDeserializationError(exception, (HttpStatusCode)200);
                }

                return result != null;
            }

            private void OnDeserializationError(Exception exception, HttpStatusCode httpStatusCode)
            {
                bool suppressDefaultLog = false;
                OnDeserializationError(ref suppressDefaultLog, exception, httpStatusCode);
                if (!suppressDefaultLog)
                    Logger.LogError(exception, "An error occurred while deserializing the {code} response.", httpStatusCode);
            }

            partial void OnDeserializationError(ref bool suppressDefaultLog, Exception exception, HttpStatusCode httpStatusCode);
        }
        
    }
}
