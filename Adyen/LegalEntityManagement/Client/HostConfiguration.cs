/*
 * Legal Entity Management API
 *
 * The Legal Entity Management API enables you to manage legal entities that contain information required for verification.  ## Authentication Each request to the Legal Entity Management API must be signed with an API key. Generate an API key in your Customer Area if you have a [platform setup](https://docs.adyen.com/platforms/manage-access/api-credentials-web-service/#generate-api-key) or [marketplace setup](https://docs.adyen.com/marketplaces/manage-access/api-credentials-web-service/#generate-api-key).   If you have an Adyen Issuing integration, [generate an API key](https://docs.adyen.com/issuing/manage-access/api-credentials-web-service/#generate-api-key) in your Balance Platform Customer Area.  To connect to the API, add an `X-API-Key` header with the API key as the value. For example:  ``` curl -H \"X-API-Key: YOUR_API_KEY\" \\ -H \"Content-Type: application/json\" \\ ... ``` ## Versioning The Legal Entity Management API supports [versioning](https://docs.adyen.com/development-resources/versioning) using a version suffix in the endpoint URL. This suffix has the following format: \"vXX\", where XX is the version number.  For example: ``` https://kyc-test.adyen.com/lem/v4/legalEntities ``` ## Rate limits We enforce rate limits on Legal Entity Management API endpoints. When the number of requests you send exceeds a threshold within a time frame, additional requests are blocked until the time frame ends. Current limits:  - Live environments: 700 requests per 5 seconds.  - Test environments: 200 requests per 5 seconds.  - Failed requests are subject to a limit of 5 failures per 10 seconds.  ## Going live When going live, generate an API key in your [live Customer Area](https://ca-live.adyen.com/ca/) if you have an Adyen for Platforms integration or [live Balance Platform Customer Area](https://balanceplatform-live.adyen.com/balanceplatform/) if you have an Adyen Issuing integration.You can then use the API key to send requests to `https://kyc-live.adyen.com/lem/v4`.  
 *
 * The version of the OpenAPI document: 4
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

#nullable enable

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Net.Http;
using Microsoft.Extensions.DependencyInjection;
using Adyen.LegalEntityManagement.Services;
using Adyen.LegalEntityManagement.Client;
using Adyen.LegalEntityManagement.Models;
using Adyen.Core;
using Adyen.Core.Auth;
using Adyen.Core.Client;
using Adyen.Core.Options;
using Adyen.Core.Converters;

namespace Adyen.LegalEntityManagement.Client
{
    /// <summary>
    /// Provides hosting configuration for LegalEntityManagement
    /// </summary>
    public class HostConfiguration
    {
        private readonly IServiceCollection _services;
        private readonly JsonSerializerOptions _jsonOptions = new JsonSerializerOptions();
        private readonly AdyenOptions _adyenOptions = new AdyenOptions();
        
        /// <summary>
        /// The base path of the API, it includes the http(s)-scheme, the host domain name, and the base path.
        /// This value can change when `ConfigureAdyenOptions` is called in <see cref="HostConfiguration"/>). The new value will be based on the <see cref="AdyenOptions"/>.<see cref="AdyenEnvironment"/>.
        /// </summary>
        public static string BASE_URL = "https://kyc-test.adyen.com/lem/v4";
        
        /// <summary>
        /// Instantiates the HostConfiguration (custom JsonConverters, Events, HttpClient) with the necessary dependencies to communicate with the API.
        /// </summary>
        /// <param name="services"><see cref="IServiceCollection"/></param>
        public HostConfiguration(IServiceCollection services)
        {
            _services = services;
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(JsonStringEnumConverter)) == null)
                _jsonOptions.Converters.Add(new JsonStringEnumConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateTimeJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateTimeJsonConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateTimeNullableJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateTimeNullableJsonConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(ByteArrayConverter)) == null)
                _jsonOptions.Converters.Add(new ByteArrayConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateOnlyJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateOnlyJsonConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateOnlyNullableJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateOnlyNullableJsonConverter());
            _jsonOptions.Converters.Add(new AULocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new AcceptTermsOfServiceRequestJsonConverter());
            _jsonOptions.Converters.Add(new AcceptTermsOfServiceResponseJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalBankIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new AddressJsonConverter());
            _jsonOptions.Converters.Add(new AmountJsonConverter());
            _jsonOptions.Converters.Add(new AttachmentJsonConverter());
            _jsonOptions.Converters.Add(new BankAccountInfoJsonConverter());
            _jsonOptions.Converters.Add(new BankAccountInfoAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new BirthDataJsonConverter());
            _jsonOptions.Converters.Add(new BusinessLineJsonConverter());
            _jsonOptions.Converters.Add(new BusinessLineInfoJsonConverter());
            _jsonOptions.Converters.Add(new BusinessLineInfoUpdateJsonConverter());
            _jsonOptions.Converters.Add(new BusinessLinesJsonConverter());
            _jsonOptions.Converters.Add(new CALocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new CZLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new CalculatePciStatusRequestJsonConverter());
            _jsonOptions.Converters.Add(new CalculatePciStatusResponseJsonConverter());
            _jsonOptions.Converters.Add(new CalculateTermsOfServiceStatusResponseJsonConverter());
            _jsonOptions.Converters.Add(new CapabilityProblemJsonConverter());
            _jsonOptions.Converters.Add(new CapabilityProblemEntityJsonConverter());
            _jsonOptions.Converters.Add(new CapabilityProblemEntityRecursiveJsonConverter());
            _jsonOptions.Converters.Add(new CapabilitySettingsJsonConverter());
            _jsonOptions.Converters.Add(new CheckTaxElectronicDeliveryConsentResponseJsonConverter());
            _jsonOptions.Converters.Add(new DKLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new DataReviewConfirmationResponseJsonConverter());
            _jsonOptions.Converters.Add(new DocumentJsonConverter());
            _jsonOptions.Converters.Add(new DocumentPageJsonConverter());
            _jsonOptions.Converters.Add(new DocumentReferenceJsonConverter());
            _jsonOptions.Converters.Add(new EntityReferenceJsonConverter());
            _jsonOptions.Converters.Add(new FinancialReportJsonConverter());
            _jsonOptions.Converters.Add(new FinancierJsonConverter());
            _jsonOptions.Converters.Add(new GeneratePciDescriptionRequestJsonConverter());
            _jsonOptions.Converters.Add(new GeneratePciDescriptionResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetAcceptedTermsOfServiceDocumentResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetPciQuestionnaireInfosResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetPciQuestionnaireResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetTermsOfServiceAcceptanceInfosResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetTermsOfServiceDocumentRequestJsonConverter());
            _jsonOptions.Converters.Add(new GetTermsOfServiceDocumentResponseJsonConverter());
            _jsonOptions.Converters.Add(new HKLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new HULocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new IbanAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new IdentificationDataJsonConverter());
            _jsonOptions.Converters.Add(new IndividualJsonConverter());
            _jsonOptions.Converters.Add(new LegalEntityJsonConverter());
            _jsonOptions.Converters.Add(new LegalEntityAssociationJsonConverter());
            _jsonOptions.Converters.Add(new LegalEntityCapabilityJsonConverter());
            _jsonOptions.Converters.Add(new LegalEntityInfoJsonConverter());
            _jsonOptions.Converters.Add(new LegalEntityInfoRequiredTypeJsonConverter());
            _jsonOptions.Converters.Add(new NOLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new NZLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new NameJsonConverter());
            _jsonOptions.Converters.Add(new NumberAndBicAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new OnboardingLinkJsonConverter());
            _jsonOptions.Converters.Add(new OnboardingLinkInfoJsonConverter());
            _jsonOptions.Converters.Add(new OnboardingLinkSettingsJsonConverter());
            _jsonOptions.Converters.Add(new OnboardingThemeJsonConverter());
            _jsonOptions.Converters.Add(new OnboardingThemesJsonConverter());
            _jsonOptions.Converters.Add(new OrganizationJsonConverter());
            _jsonOptions.Converters.Add(new OwnerEntityJsonConverter());
            _jsonOptions.Converters.Add(new PLLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new PciDocumentInfoJsonConverter());
            _jsonOptions.Converters.Add(new PciSigningRequestJsonConverter());
            _jsonOptions.Converters.Add(new PciSigningResponseJsonConverter());
            _jsonOptions.Converters.Add(new PhoneNumberJsonConverter());
            _jsonOptions.Converters.Add(new RemediatingActionJsonConverter());
            _jsonOptions.Converters.Add(new SELocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new SGLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new ServiceErrorJsonConverter());
            _jsonOptions.Converters.Add(new SetTaxElectronicDeliveryConsentRequestJsonConverter());
            _jsonOptions.Converters.Add(new SoleProprietorshipJsonConverter());
            _jsonOptions.Converters.Add(new SourceOfFundsJsonConverter());
            _jsonOptions.Converters.Add(new StockDataJsonConverter());
            _jsonOptions.Converters.Add(new SupportJsonConverter());
            _jsonOptions.Converters.Add(new SupportingEntityCapabilityJsonConverter());
            _jsonOptions.Converters.Add(new TaxInformationJsonConverter());
            _jsonOptions.Converters.Add(new TaxReportingClassificationJsonConverter());
            _jsonOptions.Converters.Add(new TermsOfServiceAcceptanceInfoJsonConverter());
            _jsonOptions.Converters.Add(new TransferInstrumentJsonConverter());
            _jsonOptions.Converters.Add(new TransferInstrumentInfoJsonConverter());
            _jsonOptions.Converters.Add(new TransferInstrumentReferenceJsonConverter());
            _jsonOptions.Converters.Add(new TrustJsonConverter());
            _jsonOptions.Converters.Add(new UKLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new USLocalAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new UndefinedBeneficiaryJsonConverter());
            _jsonOptions.Converters.Add(new UnincorporatedPartnershipJsonConverter());
            _jsonOptions.Converters.Add(new VerificationDeadlineJsonConverter());
            _jsonOptions.Converters.Add(new VerificationErrorJsonConverter());
            _jsonOptions.Converters.Add(new VerificationErrorRecursiveJsonConverter());
            _jsonOptions.Converters.Add(new VerificationErrorsJsonConverter());
            _jsonOptions.Converters.Add(new WebDataJsonConverter());
            _jsonOptions.Converters.Add(new WebDataExemptionJsonConverter());
            JsonSerializerOptionsProvider jsonSerializerOptionsProvider = new(_jsonOptions);
            _services.AddSingleton(jsonSerializerOptionsProvider);
            _services.AddSingleton<IApiFactory, ApiFactory>();
            _services.AddSingleton<BusinessLinesServiceEvents>();
            _services.AddSingleton<DocumentsServiceEvents>();
            _services.AddSingleton<HostedOnboardingServiceEvents>();
            _services.AddSingleton<LegalEntitiesServiceEvents>();
            _services.AddSingleton<PCIQuestionnairesServiceEvents>();
            _services.AddSingleton<TaxEDeliveryConsentServiceEvents>();
            _services.AddSingleton<TermsOfServiceServiceEvents>();
            _services.AddSingleton<TransferInstrumentsServiceEvents>();
        }

        /// <summary>
        /// Configures the <see cref="System.Net.Http.HttpClient"/> and <see cref="IHttpClientBuilder"/>.
        /// </summary>
        /// <param name="httpClientOptions">Configures the <see cref="System.Net.Http.HttpClient"/>.</param>
        /// <param name="httpClientBuilderOptions">Configures the <see cref="IHttpClientBuilder"/>.</param>
        /// <returns><see cref="HostConfiguration"/>.</returns>
        public HostConfiguration AddLegalEntityManagementHttpClients(Action<System.Net.Http.HttpClient>? httpClientOptions = null, Action<IHttpClientBuilder>? httpClientBuilderOptions = null)
        {
            Action<System.Net.Http.HttpClient> httpClientAction = httpClient =>
            {
                // Configure HttpClient set by the user.
                httpClientOptions?.Invoke(httpClient);

                // Set BaseAddress if it's not set.
                if (httpClient.BaseAddress == null)
                    httpClient.BaseAddress = new Uri(UrlBuilderExtensions.ConstructHostUrl(_adyenOptions, BASE_URL));
            };
    
            List<IHttpClientBuilder> builders = new List<IHttpClientBuilder>();

            builders.Add(_services.AddHttpClient<IBusinessLinesService, BusinessLinesService>(httpClientAction));
            builders.Add(_services.AddHttpClient<IDocumentsService, DocumentsService>(httpClientAction));
            builders.Add(_services.AddHttpClient<IHostedOnboardingService, HostedOnboardingService>(httpClientAction));
            builders.Add(_services.AddHttpClient<ILegalEntitiesService, LegalEntitiesService>(httpClientAction));
            builders.Add(_services.AddHttpClient<IPCIQuestionnairesService, PCIQuestionnairesService>(httpClientAction));
            builders.Add(_services.AddHttpClient<ITaxEDeliveryConsentService, TaxEDeliveryConsentService>(httpClientAction));
            builders.Add(_services.AddHttpClient<ITermsOfServiceService, TermsOfServiceService>(httpClientAction));
            builders.Add(_services.AddHttpClient<ITransferInstrumentsService, TransferInstrumentsService>(httpClientAction));
            
            if (httpClientBuilderOptions != null)
                foreach (IHttpClientBuilder builder in builders)
                    httpClientBuilderOptions(builder);
            
            return this;
        }

        /// <summary>
        /// Configures the <see cref="JsonSerializerOptions"/>.
        /// </summary>
        /// <param name="jsonSerializerOptions">Configures the <see cref="JsonSerializerOptions"/>.</param>
        /// <returns><see cref="HostConfiguration"/>.</returns>
        public HostConfiguration ConfigureJsonOptions(Action<JsonSerializerOptions> jsonSerializerOptions)
        {
            jsonSerializerOptions(_jsonOptions);
            
            return this;
        }

        /// <summary>
        /// Configures the <see cref="AdyenOptions"/> (e.g. Environment, LiveEndpointPrefix).
        /// </summary>
        /// <param name="adyenOptions">Configures the <see cref="AdyenOptions"/>.</param>
        /// <returns><see cref="HostConfiguration"/>.</returns>
        public HostConfiguration ConfigureAdyenOptions(Action<AdyenOptions> adyenOptions)
        {
            adyenOptions(_adyenOptions);
            _services.AddSingleton<ITokenProvider<ApiKeyToken>>(
                new TokenProvider<ApiKeyToken>(
                    new ApiKeyToken(_adyenOptions.AdyenApiKey, ClientUtils.ApiKeyHeader.X_API_Key, "")
                )
            );
                    
            return this;
        }
    }
}
