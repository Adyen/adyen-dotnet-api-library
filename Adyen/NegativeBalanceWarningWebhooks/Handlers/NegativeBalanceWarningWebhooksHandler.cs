// <auto-generated>
/*
 * Negative balance compensation warning 
 *
 * Adyen sends webhooks to inform you about balance accounts whose balance has been negative for 20 or more days. If you do not transfer funds to that balance account to cover the negative balance before the scheduled compensation date, a transfer is made from your liable balance account on that date.
 *
 * The version of the OpenAPI document: 1
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

#nullable enable

using Microsoft.Extensions.Logging;
using System.Text.Json;
using Adyen.Core.Auth;
using Adyen.NegativeBalanceWarningWebhooks.Client;
using Adyen.NegativeBalanceWarningWebhooks.Models;

namespace Adyen.NegativeBalanceWarningWebhooks.Handlers
{
    /// <summary>
    /// Interface for deserializing NegativeBalanceWarningWebhooks webhooks or verify its HMAC signature.
    /// </summary>
    public interface INegativeBalanceWarningWebhooksHandler
    {
        /// <summary>
        /// Returns the <see cref="JsonSerializerOptionsProvider"/> to deserialize the json payload from the webhook. This is initialized in the <see cref="HostConfiguration"/>.
        /// </summary>
        Adyen.NegativeBalanceWarningWebhooks.Client.JsonSerializerOptionsProvider JsonSerializerOptionsProvider { get; }
            
        /// <summary>
        /// Uses <see cref="Adyen.NegativeBalanceWarningWebhooks.Client.JsonSerializerOptionsProvider"/> to attempt to deserialize <see cref="NegativeBalanceCompensationWarningNotificationRequest"/>.
        /// </summary>
        /// <param name="json">The full webhook payload.</param>
        /// <exception cref="JsonException"></exception>
        NegativeBalanceCompensationWarningNotificationRequest? DeserializeNegativeBalanceCompensationWarningNotificationRequest(string json);

        /// <summary>
        /// Verifies the HMAC signature of the webhook json payload.
        /// </summary>
        /// <param name="json">The full webhook payload.</param>
        /// <param name="hmacSignature">The signature from the webhook.</param>
        /// <returns>True if the HMAC signature is valid</returns>
        bool IsValidHmacSignature(string json, string hmacSignature);
    }

    /// <summary>
    /// Handler utility function used to deserialize NegativeBalanceWarningWebhooks or verify the HMAC signature of the webhook.
    /// </summary>
    public partial class NegativeBalanceWarningWebhooksHandler : INegativeBalanceWarningWebhooksHandler
    {
        /// <summary>
        /// The `ADYEN_HMAC_KEY` configured in <see cref="Adyen.Core.Options.AdyenOptions"/>.
        /// </summary>
        private readonly string? _adyenHmacKey;

        /// <inheritdoc/>
        public Adyen.NegativeBalanceWarningWebhooks.Client.JsonSerializerOptionsProvider JsonSerializerOptionsProvider { get; }
        
        /// <summary>
        /// Initializes the handler utility for deserializing NegativeBalanceWarningWebhooks or verify its HMAC signature.
        /// </summary>
        /// <param name="jsonSerializerOptionsProvider"><see cref="Adyen.AcsWebhooks.Client.JsonSerializerOptionsProvider"/>.</param>
        /// <param name="hmacKeyProvider"><see cref="Adyen.AcsWebhooks.Client.JsonSerializerOptionsProvider"/> which contains the HMACKey configured in <see cref="Adyen.Core.Options.AdyenOptions"/>.</param>
        public NegativeBalanceWarningWebhooksHandler(Adyen.NegativeBalanceWarningWebhooks.Client.JsonSerializerOptionsProvider jsonSerializerOptionsProvider, ITokenProvider<HmacKeyToken> hmacKeyProvider = null)
        {
            JsonSerializerOptionsProvider = jsonSerializerOptionsProvider;
        }

        /// <inheritdoc/>
        public NegativeBalanceCompensationWarningNotificationRequest? DeserializeNegativeBalanceCompensationWarningNotificationRequest(string json)
        {
            return JsonSerializer.Deserialize<NegativeBalanceCompensationWarningNotificationRequest>(json, JsonSerializerOptionsProvider.Options);
        }

        /// <inheritdoc/>
        public bool IsValidHmacSignature(string json, string hmacSignature)
        {
            return Adyen.Core.Utilities.HmacValidatorUtility.IsHmacSignatureValid(hmacSignature, _adyenHmacKey, json);
        }
    }
}
