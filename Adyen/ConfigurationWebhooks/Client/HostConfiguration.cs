/*
 * Configuration webhooks
 *
 * Adyen sends webhooks to inform your system about events that occur in your platform. These events include, for example, when an account holder's capabilities are updated, or when a sweep configuration is created or updated.  When an event occurs, Adyen makes an HTTP POST request to a URL on your server and includes the details of the event in the request body.  You can use these webhooks to build your implementation. For example, you can use this information to update internal statuses when the status of a capability is changed.
 *
 * The version of the OpenAPI document: 2
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

#nullable enable

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Net.Http;
using Microsoft.Extensions.DependencyInjection;

using Adyen.ConfigurationWebhooks.Client;
using Adyen.ConfigurationWebhooks.Models;
using Adyen.Core;
using Adyen.Core.Auth;
using Adyen.Core.Client;
using Adyen.Core.Options;
using Adyen.Core.Converters;

namespace Adyen.ConfigurationWebhooks.Client
{
    /// <summary>
    /// Provides hosting configuration for ConfigurationWebhooks
    /// </summary>
    public class HostConfiguration
    {
        private readonly IServiceCollection _services;
        private readonly JsonSerializerOptions _jsonOptions = new JsonSerializerOptions();
        private readonly AdyenOptions _adyenOptions = new AdyenOptions();
        
        /// <summary>
        /// The base path of the API, it includes the http(s)-scheme, the host domain name, and the base path.
        /// This value can change when `ConfigureAdyenOptions` is called in <see cref="HostConfiguration"/>). The new value will be based on the <see cref="AdyenOptions"/>.<see cref="AdyenEnvironment"/>.
        /// </summary>
        public static string BASE_URL = "http://localhost";
        
        /// <summary>
        /// Instantiates the HostConfiguration (custom JsonConverters, Events, HttpClient) with the necessary dependencies to communicate with the API.
        /// </summary>
        /// <param name="services"><see cref="IServiceCollection"/></param>
        public HostConfiguration(IServiceCollection services)
        {
            _services = services;
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(JsonStringEnumConverter)) == null)
                _jsonOptions.Converters.Add(new JsonStringEnumConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateTimeJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateTimeJsonConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateTimeNullableJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateTimeNullableJsonConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(ByteArrayConverter)) == null)
                _jsonOptions.Converters.Add(new ByteArrayConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateOnlyJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateOnlyJsonConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateOnlyNullableJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateOnlyNullableJsonConverter());
            _jsonOptions.Converters.Add(new AccountHolderJsonConverter());
            _jsonOptions.Converters.Add(new AccountHolderCapabilityJsonConverter());
            _jsonOptions.Converters.Add(new AccountHolderNotificationDataJsonConverter());
            _jsonOptions.Converters.Add(new AccountHolderNotificationRequestJsonConverter());
            _jsonOptions.Converters.Add(new AccountSupportingEntityCapabilityJsonConverter());
            _jsonOptions.Converters.Add(new AddressJsonConverter());
            _jsonOptions.Converters.Add(new AmountJsonConverter());
            _jsonOptions.Converters.Add(new AuthenticationJsonConverter());
            _jsonOptions.Converters.Add(new BalanceJsonConverter());
            _jsonOptions.Converters.Add(new BalanceAccountJsonConverter());
            _jsonOptions.Converters.Add(new BalanceAccountNotificationDataJsonConverter());
            _jsonOptions.Converters.Add(new BalanceAccountNotificationRequestJsonConverter());
            _jsonOptions.Converters.Add(new BalancePlatformNotificationResponseJsonConverter());
            _jsonOptions.Converters.Add(new BankAccountDetailsJsonConverter());
            _jsonOptions.Converters.Add(new BankScoreSignalTriggeredDataJsonConverter());
            _jsonOptions.Converters.Add(new BulkAddressJsonConverter());
            _jsonOptions.Converters.Add(new CapabilityProblemJsonConverter());
            _jsonOptions.Converters.Add(new CapabilityProblemEntityJsonConverter());
            _jsonOptions.Converters.Add(new CapabilityProblemEntityRecursiveJsonConverter());
            _jsonOptions.Converters.Add(new CapabilitySettingsJsonConverter());
            _jsonOptions.Converters.Add(new CardJsonConverter());
            _jsonOptions.Converters.Add(new CardConfigurationJsonConverter());
            _jsonOptions.Converters.Add(new CardOrderItemJsonConverter());
            _jsonOptions.Converters.Add(new CardOrderItemDeliveryStatusJsonConverter());
            _jsonOptions.Converters.Add(new CardOrderNotificationRequestJsonConverter());
            _jsonOptions.Converters.Add(new ContactDetailsJsonConverter());
            _jsonOptions.Converters.Add(new DeliveryAddressJsonConverter());
            _jsonOptions.Converters.Add(new DeliveryContactJsonConverter());
            _jsonOptions.Converters.Add(new DeviceJsonConverter());
            _jsonOptions.Converters.Add(new ExpiryJsonConverter());
            _jsonOptions.Converters.Add(new IbanAccountIdentificationJsonConverter());
            _jsonOptions.Converters.Add(new NameJsonConverter());
            _jsonOptions.Converters.Add(new NetworkTokenNotificationDataV2JsonConverter());
            _jsonOptions.Converters.Add(new NetworkTokenNotificationRequestJsonConverter());
            _jsonOptions.Converters.Add(new NetworkTokenRequestorJsonConverter());
            _jsonOptions.Converters.Add(new NetworkTokenRiskRuleDataJsonConverter());
            _jsonOptions.Converters.Add(new NetworkTokenRiskRuleSourceJsonConverter());
            _jsonOptions.Converters.Add(new NetworkTokenTransactionRulesResultJsonConverter());
            _jsonOptions.Converters.Add(new NetworkTokenTriggeredRiskRuleJsonConverter());
            _jsonOptions.Converters.Add(new PaymentInstrumentJsonConverter());
            _jsonOptions.Converters.Add(new PaymentInstrumentAdditionalBankAccountIdentificationsInnerJsonConverter());
            _jsonOptions.Converters.Add(new PaymentInstrumentNotificationDataJsonConverter());
            _jsonOptions.Converters.Add(new PaymentNotificationRequestJsonConverter());
            _jsonOptions.Converters.Add(new PhoneJsonConverter());
            _jsonOptions.Converters.Add(new PhoneNumberJsonConverter());
            _jsonOptions.Converters.Add(new PlatformPaymentConfigurationJsonConverter());
            _jsonOptions.Converters.Add(new RemediatingActionJsonConverter());
            _jsonOptions.Converters.Add(new ResourceJsonConverter());
            _jsonOptions.Converters.Add(new ResourceReferenceJsonConverter());
            _jsonOptions.Converters.Add(new ScoreNotificationRequestJsonConverter());
            _jsonOptions.Converters.Add(new SweepConfigurationNotificationDataJsonConverter());
            _jsonOptions.Converters.Add(new SweepConfigurationNotificationRequestJsonConverter());
            _jsonOptions.Converters.Add(new SweepConfigurationV2JsonConverter());
            _jsonOptions.Converters.Add(new SweepCounterpartyJsonConverter());
            _jsonOptions.Converters.Add(new SweepScheduleJsonConverter());
            _jsonOptions.Converters.Add(new TokenAuthenticationJsonConverter());
            _jsonOptions.Converters.Add(new ValidationFactsJsonConverter());
            _jsonOptions.Converters.Add(new VerificationDeadlineJsonConverter());
            _jsonOptions.Converters.Add(new VerificationErrorJsonConverter());
            _jsonOptions.Converters.Add(new VerificationErrorRecursiveJsonConverter());
            _jsonOptions.Converters.Add(new WalletJsonConverter());
            JsonSerializerOptionsProvider jsonSerializerOptionsProvider = new(_jsonOptions);
            _services.AddSingleton(jsonSerializerOptionsProvider);
            _services.AddSingleton<IApiFactory, ApiFactory>();
        }

        /// <summary>
        /// Configures the <see cref="System.Net.Http.HttpClient"/> and <see cref="IHttpClientBuilder"/>.
        /// </summary>
        /// <param name="httpClientOptions">Configures the <see cref="System.Net.Http.HttpClient"/>.</param>
        /// <param name="httpClientBuilderOptions">Configures the <see cref="IHttpClientBuilder"/>.</param>
        /// <returns><see cref="HostConfiguration"/>.</returns>
        public HostConfiguration AddConfigurationWebhooksHttpClients(Action<System.Net.Http.HttpClient>? httpClientOptions = null, Action<IHttpClientBuilder>? httpClientBuilderOptions = null)
        {
            Action<System.Net.Http.HttpClient> httpClientAction = httpClient =>
            {
                // Configure HttpClient set by the user.
                httpClientOptions?.Invoke(httpClient);

                // Set BaseAddress if it's not set.
                if (httpClient.BaseAddress == null)
                    httpClient.BaseAddress = new Uri(UrlBuilderExtensions.ConstructHostUrl(_adyenOptions, BASE_URL));
            };
    
            List<IHttpClientBuilder> builders = new List<IHttpClientBuilder>();

            
            if (httpClientBuilderOptions != null)
                foreach (IHttpClientBuilder builder in builders)
                    httpClientBuilderOptions(builder);
            
            return this;
        }

        /// <summary>
        /// Configures the <see cref="JsonSerializerOptions"/>.
        /// </summary>
        /// <param name="jsonSerializerOptions">Configures the <see cref="JsonSerializerOptions"/>.</param>
        /// <returns><see cref="HostConfiguration"/>.</returns>
        public HostConfiguration ConfigureJsonOptions(Action<JsonSerializerOptions> jsonSerializerOptions)
        {
            jsonSerializerOptions(_jsonOptions);
            
            return this;
        }

        /// <summary>
        /// Configures the <see cref="AdyenOptions"/> (e.g. Environment, LiveEndpointPrefix).
        /// </summary>
        /// <param name="adyenOptions">Configures the <see cref="AdyenOptions"/>.</param>
        /// <returns><see cref="HostConfiguration"/>.</returns>
        public HostConfiguration ConfigureAdyenOptions(Action<AdyenOptions> adyenOptions)
        {
            adyenOptions(_adyenOptions);
            return this;
        }
    }
}
