/*
 * Adyen Checkout API
 *
 * Adyen Checkout API provides a simple and flexible way to initiate and authorise online payments. You can use the same integration for payments made with cards (including 3D Secure), mobile wallets, and local payment methods (for example, iDEAL and Sofort).  This API reference provides information on available endpoints and how to interact with them. To learn more about the API, visit [online payments documentation](https://docs.adyen.com/online-payments).  ## Authentication Each request to Checkout API must be signed with an API key. For this, [get your API key](https://docs.adyen.com/development-resources/api-credentials#generate-api-key) from your Customer Area, and set this key to the `X-API-Key` header value, for example:  ``` curl -H \"Content-Type: application/json\" \\ -H \"X-API-Key: YOUR_API_KEY\" \\ ... ``` ## Versioning Checkout API supports [versioning](https://docs.adyen.com/development-resources/versioning) using a version suffix in the endpoint URL. This suffix has the following format: \"vXX\", where XX is the version number.  For example: ``` https://checkout-test.adyen.com/v71/payments ```  ## Server-side API libraries We provide open-source [server-side API libraries](https://docs.adyen.com/development-resources/libraries/) in several languages:  - PHP - Java - Node.js - .NET - Go - Python - Ruby - Apex (beta)  See our [integration examples](https://github.com/adyen-examples#%EF%B8%8F-official-integration-examples) for example uses of the libraries.  ## Developer resources Checkout API is available through a Postman collection. Click the button below to create a fork, then set the environment variables at **Environments**&nbsp;>&nbsp;**Adyen&nbsp;APIs**.   [![Run in Postman](https://run.pstmn.io/button.svg)](https://god.gw.postman.com/run-collection/25716737-46ad970e-dc9e-4246-bac2-769c6083e7b5?action=collection%2Ffork&source=rip_markdown&collection-url=entityId%3D25716737-46ad970e-dc9e-4246-bac2-769c6083e7b5%26entityType%3Dcollection%26workspaceId%3Da8d63f9f-cfc7-4810-90c5-9e0c60030d3e#?env%5BAdyen%20APIs%5D=W3sia2V5IjoiWC1BUEktS2V5IiwidmFsdWUiOiIiLCJlbmFibGVkIjp0cnVlLCJ0eXBlIjoic2VjcmV0In0seyJrZXkiOiJZT1VSX01FUkNIQU5UX0FDQ09VTlQiLCJ2YWx1ZSI6IiIsImVuYWJsZWQiOnRydWUsInR5cGUiOiJkZWZhdWx0In0seyJrZXkiOiJZT1VSX0NPTVBBTllfQUNDT1VOVCIsInZhbHVlIjoiIiwiZW5hYmxlZCI6dHJ1ZSwidHlwZSI6ImRlZmF1bHQifSx7ImtleSI6IllPVVJfQkFMQU5DRV9QTEFURk9STSIsInZhbHVlIjoiIiwiZW5hYmxlZCI6dHJ1ZSwidHlwZSI6ImRlZmF1bHQifV0=)   ## Going live  To access the live endpoints, you need an API key from your live Customer Area.  The live endpoint URLs contain a prefix which is unique to your company account, for example: ``` https://{PREFIX}-checkout-live.adyenpayments.com/checkout/v71/payments ```  Get your `{PREFIX}` from your live Customer Area under **Developers** > **API URLs** > **Prefix**.  When preparing to do live transactions with Checkout API, follow the [go-live checklist](https://docs.adyen.com/online-payments/go-live-checklist) to make sure you've got all the required configuration in place.  ## Release notes Have a look at the [release notes](https://docs.adyen.com/online-payments/release-notes?integration_type=api&version=71) to find out what changed in this version!
 *
 * The version of the OpenAPI document: 71
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

#nullable enable

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Net.Http;
using Microsoft.Extensions.DependencyInjection;
using Adyen.Checkout.Services;
using Adyen.Checkout.Client;
using Adyen.Checkout.Models;
using Adyen.Core;
using Adyen.Core.Auth;
using Adyen.Core.Client;
using Adyen.Core.Options;
using Adyen.Core.Converters;

namespace Adyen.Checkout.Client
{
    /// <summary>
    /// Provides hosting configuration for Checkout
    /// </summary>
    public class HostConfiguration
    {
        private readonly IServiceCollection _services;
        private readonly JsonSerializerOptions _jsonOptions = new JsonSerializerOptions();
        private readonly AdyenOptions _adyenOptions = new AdyenOptions();

        internal bool HttpClientsAdded { get; private set; }
        
        /// <summary>
        /// The base path of the API, it includes the http(s)-scheme, the host domain name, and the base path.
        /// This value can change when `ConfigureAdyenOptions` is called in <see cref="HostConfiguration"/>). The new value will be based on the <see cref="AdyenOptions"/>.<see cref="AdyenEnvironment"/>.
        /// </summary>
        public static string BASE_URL = "https://checkout-test.adyen.com/v71";

        /// <summary>
        /// The relative path of the API after the `.com`.
        /// </summary>
        public static string RELATIVE_URL = "/v71";
        
        /// <summary>
        /// Instantiates the HostConfiguration (custom JsonConverters, Events, HttpClient) with the necessary dependencies to communicate with the API.
        /// </summary>
        /// <param name="services"><see cref="IServiceCollection"/></param>
        public HostConfiguration(IServiceCollection services)
        {
            _services = services;
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(JsonStringEnumConverter)) == null)
                _jsonOptions.Converters.Add(new JsonStringEnumConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateTimeJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateTimeJsonConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateTimeNullableJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateTimeNullableJsonConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateOnlyJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateOnlyJsonConverter());
            if (_jsonOptions.Converters.FirstOrDefault(x => x.GetType() == typeof(DateOnlyNullableJsonConverter)) == null)
                _jsonOptions.Converters.Add(new DateOnlyNullableJsonConverter());
            _jsonOptions.Converters.Add(new AccountInfoJsonConverter());
            _jsonOptions.Converters.Add(new AcctInfoJsonConverter());
            _jsonOptions.Converters.Add(new AchDetailsJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalData3DSecureJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalDataAirlineJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalDataCarRentalJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalDataCommonJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalDataLevel23JsonConverter());
            _jsonOptions.Converters.Add(new AdditionalDataLodgingJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalDataOpenInvoiceJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalDataOpiJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalDataRatepayJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalDataRetryJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalDataRiskJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalDataRiskStandaloneJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalDataSubMerchantJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalDataTemporaryServicesJsonConverter());
            _jsonOptions.Converters.Add(new AdditionalDataWalletsJsonConverter());
            _jsonOptions.Converters.Add(new AddressJsonConverter());
            _jsonOptions.Converters.Add(new AffirmDetailsJsonConverter());
            _jsonOptions.Converters.Add(new AfterpayDetailsJsonConverter());
            _jsonOptions.Converters.Add(new AgencyJsonConverter());
            _jsonOptions.Converters.Add(new AirlineJsonConverter());
            _jsonOptions.Converters.Add(new AmazonPayDetailsJsonConverter());
            _jsonOptions.Converters.Add(new AmountJsonConverter());
            _jsonOptions.Converters.Add(new AmountsJsonConverter());
            _jsonOptions.Converters.Add(new AncvDetailsJsonConverter());
            _jsonOptions.Converters.Add(new AndroidPayDetailsJsonConverter());
            _jsonOptions.Converters.Add(new ApplePayDetailsJsonConverter());
            _jsonOptions.Converters.Add(new ApplePayDonationsJsonConverter());
            _jsonOptions.Converters.Add(new ApplePaySessionRequestJsonConverter());
            _jsonOptions.Converters.Add(new ApplePaySessionResponseJsonConverter());
            _jsonOptions.Converters.Add(new ApplicationInfoJsonConverter());
            _jsonOptions.Converters.Add(new AuthenticationDataJsonConverter());
            _jsonOptions.Converters.Add(new BacsDirectDebitDetailsJsonConverter());
            _jsonOptions.Converters.Add(new BalanceCheckRequestJsonConverter());
            _jsonOptions.Converters.Add(new BalanceCheckResponseJsonConverter());
            _jsonOptions.Converters.Add(new BillDeskDetailsJsonConverter());
            _jsonOptions.Converters.Add(new BillingAddressJsonConverter());
            _jsonOptions.Converters.Add(new BlikDetailsJsonConverter());
            _jsonOptions.Converters.Add(new BrowserInfoJsonConverter());
            _jsonOptions.Converters.Add(new CancelOrderRequestJsonConverter());
            _jsonOptions.Converters.Add(new CancelOrderResponseJsonConverter());
            _jsonOptions.Converters.Add(new CardBrandDetailsJsonConverter());
            _jsonOptions.Converters.Add(new CardDetailsJsonConverter());
            _jsonOptions.Converters.Add(new CardDetailsRequestJsonConverter());
            _jsonOptions.Converters.Add(new CardDetailsResponseJsonConverter());
            _jsonOptions.Converters.Add(new CardDonationsJsonConverter());
            _jsonOptions.Converters.Add(new CashAppDetailsJsonConverter());
            _jsonOptions.Converters.Add(new CellulantDetailsJsonConverter());
            _jsonOptions.Converters.Add(new CheckoutAwaitActionJsonConverter());
            _jsonOptions.Converters.Add(new CheckoutBankAccountJsonConverter());
            _jsonOptions.Converters.Add(new CheckoutBankTransferActionJsonConverter());
            _jsonOptions.Converters.Add(new CheckoutDelegatedAuthenticationActionJsonConverter());
            _jsonOptions.Converters.Add(new CheckoutNativeRedirectActionJsonConverter());
            _jsonOptions.Converters.Add(new CheckoutOrderResponseJsonConverter());
            _jsonOptions.Converters.Add(new CheckoutPaymentMethodJsonConverter());
            _jsonOptions.Converters.Add(new CheckoutQrCodeActionJsonConverter());
            _jsonOptions.Converters.Add(new CheckoutRedirectActionJsonConverter());
            _jsonOptions.Converters.Add(new CheckoutSDKActionJsonConverter());
            _jsonOptions.Converters.Add(new CheckoutSessionInstallmentOptionJsonConverter());
            _jsonOptions.Converters.Add(new CheckoutSessionThreeDS2RequestDataJsonConverter());
            _jsonOptions.Converters.Add(new CheckoutThreeDS2ActionJsonConverter());
            _jsonOptions.Converters.Add(new CheckoutVoucherActionJsonConverter());
            _jsonOptions.Converters.Add(new CommonFieldJsonConverter());
            _jsonOptions.Converters.Add(new CompanyJsonConverter());
            _jsonOptions.Converters.Add(new CreateCheckoutSessionRequestJsonConverter());
            _jsonOptions.Converters.Add(new CreateCheckoutSessionResponseJsonConverter());
            _jsonOptions.Converters.Add(new CreateOrderRequestJsonConverter());
            _jsonOptions.Converters.Add(new CreateOrderResponseJsonConverter());
            _jsonOptions.Converters.Add(new DefaultErrorResponseEntityJsonConverter());
            _jsonOptions.Converters.Add(new DeliveryAddressJsonConverter());
            _jsonOptions.Converters.Add(new DeliveryMethodJsonConverter());
            _jsonOptions.Converters.Add(new DetailsRequestAuthenticationDataJsonConverter());
            _jsonOptions.Converters.Add(new DeviceRenderOptionsJsonConverter());
            _jsonOptions.Converters.Add(new DokuDetailsJsonConverter());
            _jsonOptions.Converters.Add(new DonationJsonConverter());
            _jsonOptions.Converters.Add(new DonationCampaignJsonConverter());
            _jsonOptions.Converters.Add(new DonationCampaignsRequestJsonConverter());
            _jsonOptions.Converters.Add(new DonationCampaignsResponseJsonConverter());
            _jsonOptions.Converters.Add(new DonationPaymentMethodJsonConverter());
            _jsonOptions.Converters.Add(new DonationPaymentRequestJsonConverter());
            _jsonOptions.Converters.Add(new DonationPaymentResponseJsonConverter());
            _jsonOptions.Converters.Add(new DragonpayDetailsJsonConverter());
            _jsonOptions.Converters.Add(new EBankingFinlandDetailsJsonConverter());
            _jsonOptions.Converters.Add(new EcontextVoucherDetailsJsonConverter());
            _jsonOptions.Converters.Add(new EftDetailsJsonConverter());
            _jsonOptions.Converters.Add(new EncryptedOrderDataJsonConverter());
            _jsonOptions.Converters.Add(new EnhancedSchemeDataJsonConverter());
            _jsonOptions.Converters.Add(new ExternalPlatformJsonConverter());
            _jsonOptions.Converters.Add(new FastlaneDetailsJsonConverter());
            _jsonOptions.Converters.Add(new ForexQuoteJsonConverter());
            _jsonOptions.Converters.Add(new FraudCheckResultJsonConverter());
            _jsonOptions.Converters.Add(new FraudResultJsonConverter());
            _jsonOptions.Converters.Add(new FundOriginJsonConverter());
            _jsonOptions.Converters.Add(new FundRecipientJsonConverter());
            _jsonOptions.Converters.Add(new GenericIssuerPaymentMethodDetailsJsonConverter());
            _jsonOptions.Converters.Add(new GooglePayDetailsJsonConverter());
            _jsonOptions.Converters.Add(new GooglePayDonationsJsonConverter());
            _jsonOptions.Converters.Add(new IdealDetailsJsonConverter());
            _jsonOptions.Converters.Add(new IdealDonationsJsonConverter());
            _jsonOptions.Converters.Add(new InputDetailJsonConverter());
            _jsonOptions.Converters.Add(new InstallmentOptionJsonConverter());
            _jsonOptions.Converters.Add(new InstallmentsJsonConverter());
            _jsonOptions.Converters.Add(new InvalidFieldJsonConverter());
            _jsonOptions.Converters.Add(new ItemJsonConverter());
            _jsonOptions.Converters.Add(new KlarnaDetailsJsonConverter());
            _jsonOptions.Converters.Add(new LegJsonConverter());
            _jsonOptions.Converters.Add(new LineItemJsonConverter());
            _jsonOptions.Converters.Add(new ListStoredPaymentMethodsResponseJsonConverter());
            _jsonOptions.Converters.Add(new MandateJsonConverter());
            _jsonOptions.Converters.Add(new MasterpassDetailsJsonConverter());
            _jsonOptions.Converters.Add(new MbwayDetailsJsonConverter());
            _jsonOptions.Converters.Add(new MerchantDeviceJsonConverter());
            _jsonOptions.Converters.Add(new MerchantRiskIndicatorJsonConverter());
            _jsonOptions.Converters.Add(new MobilePayDetailsJsonConverter());
            _jsonOptions.Converters.Add(new MolPayDetailsJsonConverter());
            _jsonOptions.Converters.Add(new NameJsonConverter());
            _jsonOptions.Converters.Add(new OpenInvoiceDetailsJsonConverter());
            _jsonOptions.Converters.Add(new PassengerJsonConverter());
            _jsonOptions.Converters.Add(new PayByBankAISDirectDebitDetailsJsonConverter());
            _jsonOptions.Converters.Add(new PayByBankDetailsJsonConverter());
            _jsonOptions.Converters.Add(new PayPalDetailsJsonConverter());
            _jsonOptions.Converters.Add(new PayPayDetailsJsonConverter());
            _jsonOptions.Converters.Add(new PayToDetailsJsonConverter());
            _jsonOptions.Converters.Add(new PayToPaymentMethodJsonConverter());
            _jsonOptions.Converters.Add(new PayUUpiDetailsJsonConverter());
            _jsonOptions.Converters.Add(new PayWithGoogleDetailsJsonConverter());
            _jsonOptions.Converters.Add(new PayWithGoogleDonationsJsonConverter());
            _jsonOptions.Converters.Add(new PaymentJsonConverter());
            _jsonOptions.Converters.Add(new PaymentAmountUpdateRequestJsonConverter());
            _jsonOptions.Converters.Add(new PaymentAmountUpdateResponseJsonConverter());
            _jsonOptions.Converters.Add(new PaymentCancelRequestJsonConverter());
            _jsonOptions.Converters.Add(new PaymentCancelResponseJsonConverter());
            _jsonOptions.Converters.Add(new PaymentCaptureRequestJsonConverter());
            _jsonOptions.Converters.Add(new PaymentCaptureResponseJsonConverter());
            _jsonOptions.Converters.Add(new PaymentCompletionDetailsJsonConverter());
            _jsonOptions.Converters.Add(new PaymentDetailsJsonConverter());
            _jsonOptions.Converters.Add(new PaymentDetailsRequestJsonConverter());
            _jsonOptions.Converters.Add(new PaymentDetailsResponseJsonConverter());
            _jsonOptions.Converters.Add(new PaymentLinkRequestJsonConverter());
            _jsonOptions.Converters.Add(new PaymentLinkResponseJsonConverter());
            _jsonOptions.Converters.Add(new PaymentMethodJsonConverter());
            _jsonOptions.Converters.Add(new PaymentMethodGroupJsonConverter());
            _jsonOptions.Converters.Add(new PaymentMethodIssuerJsonConverter());
            _jsonOptions.Converters.Add(new PaymentMethodToStoreJsonConverter());
            _jsonOptions.Converters.Add(new PaymentMethodUPIAppsJsonConverter());
            _jsonOptions.Converters.Add(new PaymentMethodsRequestJsonConverter());
            _jsonOptions.Converters.Add(new PaymentMethodsResponseJsonConverter());
            _jsonOptions.Converters.Add(new PaymentRefundRequestJsonConverter());
            _jsonOptions.Converters.Add(new PaymentRefundResponseJsonConverter());
            _jsonOptions.Converters.Add(new PaymentRequestJsonConverter());
            _jsonOptions.Converters.Add(new PaymentResponseJsonConverter());
            _jsonOptions.Converters.Add(new PaymentResponseActionJsonConverter());
            _jsonOptions.Converters.Add(new PaymentReversalRequestJsonConverter());
            _jsonOptions.Converters.Add(new PaymentReversalResponseJsonConverter());
            _jsonOptions.Converters.Add(new PaymentValidationsNameResponseJsonConverter());
            _jsonOptions.Converters.Add(new PaymentValidationsNameResultRawResponseJsonConverter());
            _jsonOptions.Converters.Add(new PaymentValidationsNameResultResponseJsonConverter());
            _jsonOptions.Converters.Add(new PaymentValidationsResponseJsonConverter());
            _jsonOptions.Converters.Add(new PaypalUpdateOrderRequestJsonConverter());
            _jsonOptions.Converters.Add(new PaypalUpdateOrderResponseJsonConverter());
            _jsonOptions.Converters.Add(new PhoneJsonConverter());
            _jsonOptions.Converters.Add(new PixDetailsJsonConverter());
            _jsonOptions.Converters.Add(new PixRecurringJsonConverter());
            _jsonOptions.Converters.Add(new PlatformChargebackLogicJsonConverter());
            _jsonOptions.Converters.Add(new PseDetailsJsonConverter());
            _jsonOptions.Converters.Add(new RakutenPayDetailsJsonConverter());
            _jsonOptions.Converters.Add(new RatepayDetailsJsonConverter());
            _jsonOptions.Converters.Add(new RecurringJsonConverter());
            _jsonOptions.Converters.Add(new ResponseAdditionalData3DSecureJsonConverter());
            _jsonOptions.Converters.Add(new ResponseAdditionalDataBillingAddressJsonConverter());
            _jsonOptions.Converters.Add(new ResponseAdditionalDataCardJsonConverter());
            _jsonOptions.Converters.Add(new ResponseAdditionalDataCommonJsonConverter());
            _jsonOptions.Converters.Add(new ResponseAdditionalDataDomesticErrorJsonConverter());
            _jsonOptions.Converters.Add(new ResponseAdditionalDataInstallmentsJsonConverter());
            _jsonOptions.Converters.Add(new ResponseAdditionalDataNetworkTokensJsonConverter());
            _jsonOptions.Converters.Add(new ResponseAdditionalDataOpiJsonConverter());
            _jsonOptions.Converters.Add(new ResponseAdditionalDataSepaJsonConverter());
            _jsonOptions.Converters.Add(new ResponseAdditionalDataSwishJsonConverter());
            _jsonOptions.Converters.Add(new ResponsePaymentMethodJsonConverter());
            _jsonOptions.Converters.Add(new ResultJsonConverter());
            _jsonOptions.Converters.Add(new ResultNullableJsonConverter());
            _jsonOptions.Converters.Add(new RiskDataJsonConverter());
            _jsonOptions.Converters.Add(new RivertyDetailsJsonConverter());
            _jsonOptions.Converters.Add(new SDKEphemPubKeyJsonConverter());
            _jsonOptions.Converters.Add(new SamsungPayDetailsJsonConverter());
            _jsonOptions.Converters.Add(new SepaDirectDebitDetailsJsonConverter());
            _jsonOptions.Converters.Add(new ServiceErrorJsonConverter());
            _jsonOptions.Converters.Add(new SessionResultResponseJsonConverter());
            _jsonOptions.Converters.Add(new ShopperIdPaymentMethodJsonConverter());
            _jsonOptions.Converters.Add(new ShopperInteractionDeviceJsonConverter());
            _jsonOptions.Converters.Add(new ShopperNameJsonConverter());
            _jsonOptions.Converters.Add(new SplitJsonConverter());
            _jsonOptions.Converters.Add(new SplitAmountJsonConverter());
            _jsonOptions.Converters.Add(new StandalonePaymentCancelRequestJsonConverter());
            _jsonOptions.Converters.Add(new StandalonePaymentCancelResponseJsonConverter());
            _jsonOptions.Converters.Add(new StoredPaymentMethodJsonConverter());
            _jsonOptions.Converters.Add(new StoredPaymentMethodDetailsJsonConverter());
            _jsonOptions.Converters.Add(new StoredPaymentMethodRequestJsonConverter());
            _jsonOptions.Converters.Add(new StoredPaymentMethodResourceJsonConverter());
            _jsonOptions.Converters.Add(new SubInputDetailJsonConverter());
            _jsonOptions.Converters.Add(new SubMerchantJsonConverter());
            _jsonOptions.Converters.Add(new SubMerchantInfoJsonConverter());
            _jsonOptions.Converters.Add(new SurchargeJsonConverter());
            _jsonOptions.Converters.Add(new TaxTotalJsonConverter());
            _jsonOptions.Converters.Add(new ThreeDS2RequestDataJsonConverter());
            _jsonOptions.Converters.Add(new ThreeDS2RequestFieldsJsonConverter());
            _jsonOptions.Converters.Add(new ThreeDS2ResponseDataJsonConverter());
            _jsonOptions.Converters.Add(new ThreeDS2ResultJsonConverter());
            _jsonOptions.Converters.Add(new ThreeDSRequestDataJsonConverter());
            _jsonOptions.Converters.Add(new ThreeDSRequestorAuthenticationInfoJsonConverter());
            _jsonOptions.Converters.Add(new ThreeDSRequestorPriorAuthenticationInfoJsonConverter());
            _jsonOptions.Converters.Add(new ThreeDSecureDataJsonConverter());
            _jsonOptions.Converters.Add(new TicketJsonConverter());
            _jsonOptions.Converters.Add(new TravelAgencyJsonConverter());
            _jsonOptions.Converters.Add(new TwintDetailsJsonConverter());
            _jsonOptions.Converters.Add(new UPIPaymentMethodJsonConverter());
            _jsonOptions.Converters.Add(new UpdatePaymentLinkRequestJsonConverter());
            _jsonOptions.Converters.Add(new UpiCollectDetailsJsonConverter());
            _jsonOptions.Converters.Add(new UpiIntentDetailsJsonConverter());
            _jsonOptions.Converters.Add(new UpiQrDetailsJsonConverter());
            _jsonOptions.Converters.Add(new UtilityRequestJsonConverter());
            _jsonOptions.Converters.Add(new UtilityResponseJsonConverter());
            _jsonOptions.Converters.Add(new ValidateShopperIdRequestJsonConverter());
            _jsonOptions.Converters.Add(new ValidateShopperIdResponseJsonConverter());
            _jsonOptions.Converters.Add(new VippsDetailsJsonConverter());
            _jsonOptions.Converters.Add(new VisaCheckoutDetailsJsonConverter());
            _jsonOptions.Converters.Add(new WeChatPayDetailsJsonConverter());
            _jsonOptions.Converters.Add(new WeChatPayMiniProgramDetailsJsonConverter());
            _jsonOptions.Converters.Add(new ZipDetailsJsonConverter());
            JsonSerializerOptionsProvider jsonSerializerOptionsProvider = new(_jsonOptions);
            _services.AddSingleton(jsonSerializerOptionsProvider);
            _services.AddSingleton<IApiFactory, ApiFactory>();
            _services.AddSingleton<DonationsServiceEvents>();
            _services.AddSingleton<ModificationsServiceEvents>();
            _services.AddSingleton<OrdersServiceEvents>();
            _services.AddSingleton<PaymentLinksServiceEvents>();
            _services.AddSingleton<PaymentsServiceEvents>();
            _services.AddSingleton<RecurringServiceEvents>();
            _services.AddSingleton<UtilityServiceEvents>();
        }

        /// <summary>
        /// Configures the HttpClients.
        /// </summary>
        /// <param name="clientAction"></param>
        /// <param name="builderAction"></param>
        /// <returns><see cref="HostConfiguration"/></returns>
        public HostConfiguration AddCheckoutHttpClients(Action<System.Net.Http.HttpClient>? clientAction = null, Action<IHttpClientBuilder>? builderAction = null)
        {
            if (clientAction == null)
                clientAction = httpClient => httpClient.BaseAddress = new Uri(ConstructHostUrl());

            List<IHttpClientBuilder> builders = new List<IHttpClientBuilder>();

            builders.Add(_services.AddHttpClient<IDonationsService, DonationsService>(clientAction));
            builders.Add(_services.AddHttpClient<IModificationsService, ModificationsService>(clientAction));
            builders.Add(_services.AddHttpClient<IOrdersService, OrdersService>(clientAction));
            builders.Add(_services.AddHttpClient<IPaymentLinksService, PaymentLinksService>(clientAction));
            builders.Add(_services.AddHttpClient<IPaymentsService, PaymentsService>(clientAction));
            builders.Add(_services.AddHttpClient<IRecurringService, RecurringService>(clientAction));
            builders.Add(_services.AddHttpClient<IUtilityService, UtilityService>(clientAction));
            
            if (builderAction != null)
                foreach (IHttpClientBuilder instance in builders)
                    builderAction(instance);

            HttpClientsAdded = true;

            return this;
        }

        /// <summary>
        /// Configures the <see cref="JsonSerializerOptions"/>.
        /// </summary>
        /// <param name="optionsAction"></param>
        /// <returns><see cref="HostConfiguration"/></returns>
        public HostConfiguration ConfigureJsonOptions(Action<JsonSerializerOptions> optionsAction)
        {
            optionsAction(_jsonOptions);
            
            return this;
        }

        /// <summary>
        /// Configures the Adyen Settings, e.g. Environment, LiveEndpointPrefix and more.
        /// </summary>
        /// <param name="optionsAction"></param>
        /// <returns></returns>
        public HostConfiguration ConfigureAdyenOptions(Action<AdyenOptions> optionsAction)
        {
            optionsAction(_adyenOptions);
            _services.AddSingleton<ITokenProvider<ApiKeyToken>>(
                new TokenProvider<ApiKeyToken>(
                    new ApiKeyToken(_adyenOptions.AdyenApiKey, ClientUtils.ApiKeyHeader.X_API_Key, "")
                )
            );
            return this;
        }

        /// <summary>
        /// Constructs the Host URL based on the selected <see cref="AdyenEnvironment"/>, used to populate the `HttpClient.BaseAddress`.
        /// </summary>
        /// <returns>String with the Host URL.</returns>
        /// <exception cref="ArgumentOutOfRangeException"></exception>
        private string ConstructHostUrl()
        {
            if (_adyenOptions.Environment == AdyenEnvironment.Live)
                return ConstructLiveUrl(_adyenOptions.LiveEndpointUrlPrefix, BASE_URL);
            
            // Some Adyen OpenApi Specifications use the live-url, instead of the test-url, this line replaces "-live" with "-test".
            // If you need to override this URL, you can do so by replacing the BASE_URL in ClientUtils.cs.
            if (_adyenOptions.Environment == AdyenEnvironment.Test)
                return BASE_URL.Replace("-live", "-test");
            
            throw new ArgumentOutOfRangeException(_adyenOptions.Environment.ToString());
        }
        
        /// <summary>
        /// Construct LIVE BaseUrl, add the liveEndpointUrlPrefix it's the Checkout API or the Classic Payment API.
        /// This helper function can be removed when all URLs (test & live) are included in the Adyen OpenApi Specifications: https://github.com/Adyen/adyen-openapi.
        /// </summary>
        /// <param name="liveEndpointUrlPrefix">The Live EndpointUrlPrefix.</param>
        /// <param name="url">The Base URL <see cref="BASE_URL"/>.</param>
        /// <returns>baseUrl</returns>
        /// <exception cref="InvalidOperationException"></exception>
        private string ConstructLiveUrl(string liveEndpointUrlPrefix, string url)
        {
            // Change base url for Live environment
            if (url.Contains("pal-")) // Payment API prefix
            {
                if (liveEndpointUrlPrefix == null)
                {
                    throw new InvalidOperationException("LiveEndpointUrlPrefix is null - please configure your AdyenOptions.LiveEndpointUrlPrefix");
                }
                
                url = url.Replace("https://pal-test.adyen.com/pal/servlet/",
                    "https://" + liveEndpointUrlPrefix + "-pal-live.adyenpayments.com/pal/servlet/");
            }
            else if (url.Contains("checkout-")) // Checkout API prefix
            {
                if (liveEndpointUrlPrefix == null)
                {
                    throw new InvalidOperationException("LiveEndpointUrlPrefix is null - please configure your AdyenOptions.LiveEndpointUrlPrefix");
                }

                if (url.Contains("possdk"))
                {
                    url = url.Replace("https://checkout-test.adyen.com/",
                        "https://" + liveEndpointUrlPrefix + "-checkout-live.adyenpayments.com/");   
                }
                else
                {
                    url = url.Replace("https://checkout-test.adyen.com/",
                        "https://" + liveEndpointUrlPrefix + "-checkout-live.adyenpayments.com/checkout/");
                }
            }
            
            // If no prefix is required, we replace "test" -> "live"
            url = url.Replace("-test", "-live");
            return url;
        }
    }
}
